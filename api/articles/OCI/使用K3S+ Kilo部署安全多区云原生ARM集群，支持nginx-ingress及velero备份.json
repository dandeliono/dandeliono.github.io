{"title":"使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份","uid":"36fd7c99867f3cc13d5235c8e240e440","slug":"OCI/使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份","date":"2022-07-30T12:39:51.000Z","updated":"2025-12-05T01:48:00.468Z","comments":true,"path":"api/articles/OCI/使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份.json","keywords":"XuGuangSheng","cover":"/covers/k3s-kiloarmnginx-ingressvelero.jpg","content":"<h1 id=\"使用K3S-Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份\"><a href=\"#使用K3S-Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份\" class=\"headerlink\" title=\"使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份\"></a>使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份</h1><p>申请 Oracle甲骨文的Arm实例已经很久了，甲骨文的配置相当的高，4 核 24G 内存 100G 硬盘 5TB 流量，但一直没有正儿八经地用起来，属实是有些浪费资源了。于是前些天就把手上有的这些机子组了一个 ARM 集群，分属三个区域，分别为：春川 (Chuncheon)、东京 (Tokyo)、首尔 (Seoul)。由于三个机房是物理隔离开的，没有直接组在一起的链路，于是除了使用甲骨文官方的 VPN 之外，我们这次直接使用 Wireguard 将这三台机子组到一个局域网内，这样就方便组建集群了。</p>\n<p>先来看看夸张的 ARM 12 核心，70G 内存，158G 可用存储的 k3s 集群。</p>\n<p><img src=\"https://raw.githubusercontent.com/dandeliono/img/main/resource/2d2928858cb9f1a6df87ac7dc7e51636.webp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/dandeliono/img/main/resource/d2acdc8b35a645d8e09f2b0676189603.webp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/dandeliono/img/main/resource/152a439d1e6b12a4c0b0fdcc21a0ea8e.webp\"></p>\n<p>OK～前情交待完毕，以下是这次部署所需达成的目标：</p>\n<ol>\n<li>前面提到，三个机器不是一个区域的，所以需要将三台主机使用 Wireguard 组成一个局域网</li>\n<li>先不考虑高可用问题，由首尔作为控制节点，与春川和东京共为工作节点提供服务</li>\n<li>不使用甲骨文的 LB，由主机自行提供服务，域名指向其中任意一台都可以访问，也可搭配智能解析系统</li>\n<li>需要在 lb 位置集成 modsecurity，过滤一些恶意请求</li>\n<li>不使用 traefik 作为前端暴露组件，需要使用 nginx ingress(因为里面自带集成了 modsecurity)</li>\n<li>需要一个好用的控制面板，kubectl 操作起来还得连接服务器，稍显麻烦。这里还是直接使用 rancher，习惯了。</li>\n<li>需要使用分布式存储，这里直接使用 rancher 的 Longhorn 进行部署</li>\n<li>需要部署数据备份组件，这里使用开源的[velero]，可以定期备份到远程的 S3 存储服务器，作为最后的灾备恢复选项。</li>\n</ol>\n<p>以下为实操步骤：</p>\n<p>注意：这里统一使用 ubuntu 20.04 的发行版，不建议用 ubuntu 22.04，最低版本为 18.04，kubernetes 使用 v1.22 稳定版，版本太新会有其他问题的</p>\n<p>注意 2：这里有两个概念，一个是公网 IP，一个是网卡 IP，在甲骨文、阿里云等等的云服务厂商那里，公网 IP 是不会直接给到实例中的系统的，而是给一个 nat 后的 IP，这个 IP 在外部是不能访问的。而公网 IP 是可以给外部访问的。因此，在进行接下来的配置中，要注意这点。wireguard 需要使用公网 IP 地址，而 k3s 里，则是使用网卡 IP 地址。</p>\n<h2 id=\"使用-Wireguard-组局域网\"><a href=\"#使用-Wireguard-组局域网\" class=\"headerlink\" title=\"使用 Wireguard 组局域网\"></a>使用 Wireguard 组局域网</h2><p>在本例中，我们需要组建一个局域网，但与网上搜索到的直接使用 wireguard 不同，我们需要借助 Kilo 对 wireguard 进行管理和连接，因此在这里只需要安装好 wireguard 即可，后续操作在 k3s 中进行。</p>\n<h3 id=\"安装-wireguard\"><a href=\"#安装-wireguard\" class=\"headerlink\" title=\"安装 wireguard\"></a>安装 wireguard</h3><p>由于使用 ubuntu 20.04 的版本，因此不用额外操作，直接在终端内分别为三个区域的主机安装 wireguard 即可，使用命令：</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt update</span><br><span class=\"line\">apt <span class=\"keyword\">install</span> wireguard</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装部署-k3s-server-节点\"><a href=\"#安装部署-k3s-server-节点\" class=\"headerlink\" title=\"安装部署 k3s server 节点\"></a>安装部署 k3s server 节点</h2><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -sfL https:<span class=\"string\">//get.k3s.io</span> | K3S_CLUSTER_INIT=<span class=\"literal\">true</span> INSTALL_K3S_EXEC=<span class=\"string\">&quot;server&quot;</span> INSTALL_K3S_CHANNEL=v1.22 sh -s - <span class=\"params\">--node-label</span> <span class=\"string\">&quot;topology.kubernetes.io/region=seoul&quot;</span> <span class=\"params\">--node-label</span> <span class=\"string\">&quot;master-node=true&quot;</span> <span class=\"params\">--tls-san</span> &#123;&#123; server_public_ip &#125;&#125; <span class=\"params\">--advertise-address</span> &#123;&#123; server_public_ip &#125;&#125; <span class=\"params\">--disable</span> traefik <span class=\"params\">--flannel-backend</span> none <span class=\"params\">--kube-proxy-arg</span> <span class=\"string\">&quot;metrics-bind-address=0.0.0.0&quot;</span> <span class=\"params\">--kube-apiserver-arg</span> <span class=\"string\">&quot;feature-gates=EphemeralContainers=true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>简要说明：</p>\n<ol>\n<li>K3S_CLUSTER_INIT&#x3D;true : 集群模式，会安装内置的 etcd，而不是 sqlite3；</li>\n<li>INSTALL_K3S_EXEC&#x3D;”server” : 指定为 server 节点</li>\n<li>INSTALL_K3S_CHANNEL&#x3D;v1.22 : 安装的 K3S 版本，这里选择 1.22 稳定版本，不选择太新的版本；</li>\n<li>–node-label “topology.kubernetes.io&#x2F;region&#x3D;seoul” : 设置当前服务器的 label 为首尔区域；</li>\n<li>–node-label “master-node&#x3D;true” : 设置为主节点；</li>\n<li>–tls-san :  改为当前服务器公网 IPv4 地址，–tls-san<br>这个选项在 TLS 证书中增加了一个额外的主机名或 IP 作为备用名称，如果你想通过 IP 和主机名访问，可以多次指定，多个值之间用英文半角逗号分隔。注意：如果不指定 –tls-san ，可能会导致 kubectl 无法通过 server_public_ip 来访问集群；</li>\n<li>–advertise-address ： 改为当前服务器公网 IPv4 地址，用于 agent 连接 K3S Server 的 API，但是注意不要指定 –node-external-ip ，会导致无法获得用户真实 IP；</li>\n<li>–disable traefik : 关闭 traefik，后面安装 nginx-ingress</li>\n<li>–flannel-backend none : 关闭默认的 flannel CNI，后面安装 Kilo</li>\n<li>–kube-proxy-arg “metrics-bind-address&#x3D;0.0.0.0” : kube-proxy 参数，这个参数直接影响 Metrics 的获取；</li>\n<li>–kube-apiserver-arg “feature-gates&#x3D;EphemeralContainers&#x3D;true” :  （可选）启用 feature-gates：EphemeralContainers，方便在不重启 pod 的情况下附加 sidecar 进行调试。</li>\n</ol>\n<p>执行后，检查安装结果，可以看到节点已经可以找到了：</p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubectl get node </span></span><br><span class=\"line\">NAME                     STATUS   ROLES                       AGE     VERSION<span class=\"built_in\"></span></span><br><span class=\"line\"><span class=\"built_in\">instance-20190921-1325 </span>  NotReady    control-plane,etcd,master   0h01m   v1.22.12+k3s1</span><br></pre></td></tr></table></figure>\n<p>可以看到节点状态为 NotReady ，这是正常的，因为我们还没有添加网络 CNI 网络组件，接下来就开始安装它。</p>\n<h2 id=\"安装-Kilo-CNI-网络组件\"><a href=\"#安装-Kilo-CNI-网络组件\" class=\"headerlink\" title=\"安装 Kilo CNI 网络组件\"></a>安装 Kilo CNI 网络组件</h2><h3 id=\"网络拓扑\"><a href=\"#网络拓扑\" class=\"headerlink\" title=\"网络拓扑\"></a>网络拓扑</h3><p>然后我们需要指定第一台节点的拓扑，后续添加上来的 agent 节点会自动添加进来，但仍然建议对其网络进行拓扑定义，现在先定义第一台：</p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl annotate nodes<span class=\"built_in\"> instance-20190921-1325 </span>kilo.squat.ai/location=<span class=\"string\">&quot;seoul&quot;</span></span><br><span class=\"line\">kubectl annotate nodes<span class=\"built_in\"> instance-20190921-1325 </span>kilo.squat.ai/force-endpoint=<span class=\"string\">&quot;&#123;&#123; server_public_ip &#125;&#125;:51820&quot;</span></span><br><span class=\"line\">kubectl annotate nodes<span class=\"built_in\"> instance-20190921-1325 </span>kilo.squat.ai/persistent-keepalive=20</span><br></pre></td></tr></table></figure>\n<p>简单说明：</p>\n<ol>\n<li>location : 对节点进行位置定义，方便维护</li>\n<li>force-endpoint : 自动发现节点时，会有 endpoint 的定义，这个地址如果你是用内网 ipv4，就容易变成不可路由的地址，所以这里建议直接用绑定到网卡上的 IPv6 地址，进行覆盖定义</li>\n<li>persistent-keepalive : 是 wireguard 的配置选项，保活</li>\n</ol>\n<h3 id=\"安装-Kilo-CNI-组件\"><a href=\"#安装-Kilo-CNI-组件\" class=\"headerlink\" title=\"安装 Kilo CNI 组件\"></a>安装 Kilo CNI 组件</h3><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https:<span class=\"regexp\">//</span>raw.githubusercontent.com<span class=\"regexp\">/squat/</span>kilo<span class=\"regexp\">/main/m</span>anifests/crds.yaml</span><br><span class=\"line\">wget https:<span class=\"regexp\">//</span>raw.githubusercontent.com<span class=\"regexp\">/squat/</span>kilo<span class=\"regexp\">/main/m</span>anifests/kilo-k3s.yaml</span><br></pre></td></tr></table></figure>\n<p>在第二步使用 wget，是因为需要对 Kilo 的 DaemonSet 进行修改，在我们案例中，各区没有直接的网络连接，最好使用 fullmesh 模式，这部分的说明，参考：<a href=\"https://www.evlit.com/?golink=aHR0cHM6Ly9raWxvLnNxdWF0LmFpL2RvY3MvdG9wb2xvZ3kvI2Z1bGwtbWVzaA==\">https://kilo.squat.ai/docs/topology/#full-mesh</a>，添加–mesh-granularity&#x3D;full 到 kilo-k3s.yaml 守护程序 pod 模板中：</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">name: kilo</span></span><br><span class=\"line\">  <span class=\"attribute\">image</span><span class=\"punctuation\">:</span> <span class=\"string\">squat/kilo</span></span><br><span class=\"line\">  <span class=\"attribute\">args</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">--kubeconfig=/etc/kubernetes/kubeconfig</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">--hostname=$(NODE_NAME)</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">--mesh-granularity=full</span></span><br><span class=\"line\">  <span class=\"attribute\">env</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">name: NODE_NAME</span></span><br><span class=\"line\">        <span class=\"attribute\">valueFrom</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">            <span class=\"attribute\">fieldRef</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">                <span class=\"attribute\">fieldPath</span><span class=\"punctuation\">:</span> <span class=\"string\">spec.nodeName</span></span><br></pre></td></tr></table></figure>\n<p>然后执行安装</p>\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">apply</span> -f kilo-k3s.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"验证-Kilo-安装\"><a href=\"#验证-Kilo-安装\" class=\"headerlink\" title=\"验证 Kilo 安装\"></a>验证 Kilo 安装</h3><ol>\n<li>在 kube-system 命名空间下的 pod 中，可以找到 koli 的 pod 已经成功运行，状态为 RUNNING</li>\n<li>执行 kubectl get node 时查看到的节点状态由 NotReady 变为 Ready</li>\n<li>在 k3s server 节点上，已经有 kilo 的相关 annotations，示例如下：<figure class=\"highlight handlebars\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"language-xml\">apiVersion: v1</span></span><br><span class=\"line\"><span class=\"language-xml\">kind: Node</span></span><br><span class=\"line\"><span class=\"language-xml\">metadata:</span></span><br><span class=\"line\"><span class=\"language-xml\">  annotations:</span></span><br><span class=\"line\"><span class=\"language-xml\">    k3s.io/external-ip: </span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">server_public_ip</span> &#125;&#125;</span><span class=\"language-xml\"></span></span><br><span class=\"line\"><span class=\"language-xml\">    k3s.io/hostname: instance-20190921-1325</span></span><br><span class=\"line\"><span class=\"language-xml\">    k3s.io/internal-ip: 10.0.0.170</span></span><br><span class=\"line\"><span class=\"language-xml\">    ...</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/discovered-endpoints: &#x27;&#123;&quot;</span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">public_key_1</span> &#125;&#125;</span><span class=\"language-xml\">&quot;:&#123;&quot;IP&quot;:&quot;</span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">agent_public_ip_1</span> &#125;&#125;</span><span class=\"language-xml\">&quot;,&quot;Port&quot;:51820,&quot;Zone&quot;:&quot;&quot;&#125;,&quot;</span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">public_key_2</span> &#125;&#125;</span><span class=\"language-xml\">&quot;:&#123;&quot;IP&quot;:&quot;</span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">agent_public_ip_2</span> &#125;&#125;</span><span class=\"language-xml\">&quot;,&quot;Port&quot;:51820,&quot;Zone&quot;:&quot;&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/endpoint: &#x27;</span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">server_public_ip</span> &#125;&#125;</span><span class=\"language-xml\">:51820&#x27;</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/force-endpoint: &#x27;</span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">server_public_ip</span> &#125;&#125;</span><span class=\"language-xml\">:51820&#x27;</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/granularity: location</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/internal-ip: 10.0.0.170/24</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/key: </span><span class=\"template-variable\">&#123;&#123; <span class=\"name\">private_key</span> &#125;&#125;</span><span class=\"language-xml\"></span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/last-seen: &quot;1658647061&quot;</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/location: seoul</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/persistent-keepalive: &quot;20&quot;</span></span><br><span class=\"line\"><span class=\"language-xml\">    kilo.squat.ai/wireguard-ip: 10.4.0.2/16</span></span><br><span class=\"line\"><span class=\"language-xml\">...</span></span><br></pre></td></tr></table></figure>\n可以看到 discovered-endpoints 这个是内网自动发现到的节点</li>\n</ol>\n<h2 id=\"安装部署-k3s-agent-节点\"><a href=\"#安装部署-k3s-agent-节点\" class=\"headerlink\" title=\"安装部署 k3s agent 节点\"></a>安装部署 k3s agent 节点</h2><p>部署 agent 节点前，需要在 server 节点先获取到 token，后面添加 agent 节点时都需要带上，可以添加多台 agent 节点，这里以添加两台为例子。</p>\n<p>获取 token：</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat <span class=\"regexp\">/var/</span>lib<span class=\"regexp\">/rancher/</span>k3s<span class=\"regexp\">/server/</span>node-token</span><br></pre></td></tr></table></figure>\n<p>执行命令添加 agent 节点</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -sfL https://get.k3s.io  | <span class=\"attr\">INSTALL_K3S_EXEC=</span><span class=\"string\">&quot;agent&quot;</span> <span class=\"attr\">INSTALL_K3S_CHANNEL=</span>v22 <span class=\"attr\">K3S_URL=</span>https://&#123;&#123; server_public_ip &#125;&#125;:<span class=\"number\">6443</span> <span class=\"attr\">K3S_TOKEN=</span>&#123;&#123; server_token &#125;&#125; sh -s - --<span class=\"keyword\">node</span><span class=\"title\">-label</span> <span class=\"string\">&quot;topology.kubernetes.io/region=chuncheon&quot;</span> --<span class=\"keyword\">node</span><span class=\"title\">-label</span> <span class=\"string\">&quot;worker-node=true&quot;</span> --kube-proxy-arg <span class=\"string\">&quot;metrics-bind-address=0&quot;</span></span><br></pre></td></tr></table></figure>\n<p>简要说明：</p>\n<ol>\n<li>INSTALL_K3S_EXEC&#x3D;”agent” : 定义添加的是 agent 节点，将只作为工作节点加入集群，没有 etcd；</li>\n<li>INSTALL_K3S_CHANNEL&#x3D;v1.22 : 安装的 K3S 版本，这里选择 1.22 稳定版本，不选择太新的版本；</li>\n<li><code>K3S_URL=[https://&#123;&#123;](https://&#123;&#123;) server_public_ip &#125;&#125;:6443 </code>: 指定 server 节点 api 访问地址</li>\n<li>K3S_TOKEN&#x3D; : 使用上一步获取到的 token 值</li>\n<li>–node-label “topology.kubernetes.io&#x2F;region&#x3D;chuncheon” : 设置当前服务器的 label 为春川区域；</li>\n<li>–node-label “worker-node&#x3D;true” : 设置为工作节点；</li>\n<li>–kube-proxy-arg “metrics-bind-address&#x3D;0.0.0.0” : kube-proxy 参数，这个参数直接影响 Metrics 的获取；</li>\n</ol>\n<p>执行后等待 1 分钟左右，回到 k3s server 节点，执行 kubectl get node，即可看到新添加的节点，同样，这里我们对添加进来的节点进行拓扑定义</p>\n<figure class=\"highlight smali\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl annotate nodes<span class=\"built_in\"> instance-20190931-1637 </span>kilo.squat.ai/location=<span class=\"string\">&quot;chuncheon&quot;</span></span><br><span class=\"line\">kubectl annotate nodes<span class=\"built_in\"> instance-20190931-1637 </span>kilo.squat.ai/force-endpoint=<span class=\"string\">&quot;&#123;&#123; agent_public_ip &#125;&#125;:51820&quot;</span></span><br><span class=\"line\">kubectl annotate nodes<span class=\"built_in\"> instance-20190931-1637 </span>kilo.squat.ai/persistent-keepalive=20</span><br></pre></td></tr></table></figure>\n<h2 id=\"Kilo-CNI-的网卡说明\"><a href=\"#Kilo-CNI-的网卡说明\" class=\"headerlink\" title=\"Kilo CNI 的网卡说明\"></a>Kilo CNI 的网卡说明</h2><h3 id=\"网卡列表\"><a href=\"#网卡列表\" class=\"headerlink\" title=\"网卡列表\"></a>网卡列表</h3><ol>\n<li>kilo0：WireGuard VPN 网络，用以 Node 间组建 VPN 内网；如果同一个区域内存在 VPC，内网连接则优先使用 VPC 内网，只有走外部其他区域的链路才会走 WireGuard 加密网络；</li>\n<li>kube-bridge: 桥接网络，Node 内 Pod 的网卡与宿主机的网卡进行连接，如需跨网通信，则会路由到 WireGuard VPN 网络共享通信；</li>\n<li>tunl0：Bridge 模式下，多主机网络通信需要额外配置主机路由，或使用 overlay 网络。通过 Kilo 来自动配置。引用网上的一张图：</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/dandeliono/img/main/resource/c3a0f1dc10927abc1e918471b0cebe05.webp\"></p>\n<h3 id=\"路由表\"><a href=\"#路由表\" class=\"headerlink\" title=\"路由表\"></a>路由表</h3><p>首尔机器上的路由表：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ip r</span></span><br><span class=\"line\"><span class=\"attribute\">default</span> via <span class=\"number\">10.0.0.1</span> dev enp0s3 proto dhcp src <span class=\"number\">10.0.0.170</span> metric <span class=\"number\">100</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> dev enp0s3 proto kernel scope link src <span class=\"number\">10.0.0.170</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">98</span> via <span class=\"number\">10.4.0.1</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">246</span> via <span class=\"number\">10.4.0.3</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">4</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">16</span> dev kilo0 proto kernel scope link src <span class=\"number\">10.4.0.2</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> dev kube-bridge proto kernel scope link src <span class=\"number\">10.42.0.1</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">1</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> via <span class=\"number\">10.4.0.1</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">2</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> via <span class=\"number\">10.4.0.3</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">169</span>.<span class=\"number\">254</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">16</span> dev enp0s3 proto dhcp scope link src <span class=\"number\">10.0.0.170</span> metric <span class=\"number\">100</span></span><br></pre></td></tr></table></figure>\n<p>春川的路由表：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ip r</span></span><br><span class=\"line\"><span class=\"attribute\">default</span> via <span class=\"number\">10.0.0.1</span> dev enp0s3 proto dhcp src <span class=\"number\">10.0.0.98</span> metric <span class=\"number\">100</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> dev enp0s3 proto kernel scope link src <span class=\"number\">10.0.0.98</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">170</span> via <span class=\"number\">10.4.0.2</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">246</span> via <span class=\"number\">10.4.0.3</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">4</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">16</span> dev kilo0 proto kernel scope link src <span class=\"number\">10.4.0.1</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> via <span class=\"number\">10.4.0.2</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">1</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> dev kube-bridge proto kernel scope link src <span class=\"number\">10.42.1.1</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">2</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> via <span class=\"number\">10.4.0.3</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">169</span>.<span class=\"number\">254</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">16</span> dev enp0s3 proto dhcp scope link src <span class=\"number\">10.0.0.98</span> metric <span class=\"number\">100</span></span><br></pre></td></tr></table></figure>\n<p>东京的路由表：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ip r</span></span><br><span class=\"line\"><span class=\"attribute\">default</span> via <span class=\"number\">10.0.0.1</span> dev enp0s3 proto dhcp src <span class=\"number\">10.0.0.246</span> metric <span class=\"number\">100</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> dev enp0s3 proto kernel scope link src <span class=\"number\">10.0.0.246</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">98</span> via <span class=\"number\">10.4.0.1</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">170</span> via <span class=\"number\">10.4.0.2</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">4</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">16</span> dev kilo0 proto kernel scope link src <span class=\"number\">10.4.0.3</span> </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> via <span class=\"number\">10.4.0.2</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">1</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> via <span class=\"number\">10.4.0.1</span> dev kilo0 proto static onlink </span><br><span class=\"line\"><span class=\"attribute\">10</span>.<span class=\"number\">42</span>.<span class=\"number\">2</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span> dev kube-bridge proto kernel scope link src <span class=\"number\">10.42.2.1</span> </span><br><span class=\"line\"><span class=\"attribute\">169</span>.<span class=\"number\">254</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>/<span class=\"number\">16</span> dev enp0s3 proto dhcp scope link src <span class=\"number\">10.0.0.246</span> metric <span class=\"number\">100</span></span><br></pre></td></tr></table></figure>\n<p>在这里可以看到，这三台机器，已经通过各自的路由，分别都找到了对方。</p>\n<h2 id=\"安装-helm-部署软件\"><a href=\"#安装-helm-部署软件\" class=\"headerlink\" title=\"安装 helm 部署软件\"></a>安装 helm 部署软件</h2><p>helm 常用于 k8s 里的软件部署，在 k3s 里同样需要安装，执行命令：</p>\n<figure class=\"highlight dsconfig\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">https</span>://<span class=\"string\">raw</span>.<span class=\"string\">githubusercontent</span>.<span class=\"string\">com</span>/<span class=\"string\">helm</span>/<span class=\"string\">helm</span>/<span class=\"string\">main</span>/<span class=\"string\">scripts</span>/<span class=\"built_in\">get-helm-3</span> | <span class=\"string\">bash</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"安装部署-nginx-ingress\"><a href=\"#安装部署-nginx-ingress\" class=\"headerlink\" title=\"安装部署 nginx-ingress\"></a>安装部署 nginx-ingress</h2><p>nginx-ingress 直接使用 helm 进行安装，执行命令：</p>\n<figure class=\"highlight fsharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm upgrade <span class=\"operator\">--</span>install ingress<span class=\"operator\">-</span>nginx ingress<span class=\"operator\">-</span>nginx </span><br><span class=\"line\">  <span class=\"operator\">--</span>repo https<span class=\"operator\">:</span><span class=\"comment\">//kubernetes.github.io/ingress-nginx </span></span><br><span class=\"line\">  <span class=\"operator\">--</span><span class=\"keyword\">namespace</span> ingress<span class=\"operator\">-</span>nginx <span class=\"operator\">--</span>create<span class=\"operator\">-</span><span class=\"keyword\">namespace</span> </span><br><span class=\"line\">  <span class=\"operator\">--</span><span class=\"built_in\">set</span> controller.service.<span class=\"keyword\">type</span><span class=\"operator\">=</span>LoadBalancer </span><br><span class=\"line\">  <span class=\"operator\">--</span><span class=\"built_in\">set</span> controller.ingressClassResource.<span class=\"keyword\">default</span><span class=\"operator\">=</span><span class=\"literal\">true</span> </span><br><span class=\"line\">  <span class=\"operator\">--</span><span class=\"built_in\">set</span> controller.watchIngressWithoutClass<span class=\"operator\">=</span><span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"安装部署-rancher-控制面板\"><a href=\"#安装部署-rancher-控制面板\" class=\"headerlink\" title=\"安装部署 rancher 控制面板\"></a>安装部署 rancher 控制面板</h2><p>新版本 rancher 2.6 的安装与 2.5 之前不一样，2.6 版本依赖 helm，直接运行以下命令进行安装，需要提前准备的是管理后台域名的证书</p>\n<h3 id=\"首先添加-helm-的-repo\"><a href=\"#首先添加-helm-的-repo\" class=\"headerlink\" title=\"首先添加 helm 的 repo\"></a>首先添加 helm 的 repo</h3><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm repo <span class=\"keyword\">add</span> rancher-<span class=\"keyword\">stable</span> https://releases.rancher.com/<span class=\"keyword\">server</span>-charts/<span class=\"keyword\">stable</span></span><br><span class=\"line\">helm repo <span class=\"keyword\">update</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"接着将域名证书放在-x2F-etc-x2F-rancher-x2F-cert-路径中\"><a href=\"#接着将域名证书放在-x2F-etc-x2F-rancher-x2F-cert-路径中\" class=\"headerlink\" title=\"接着将域名证书放在 &#x2F; etc&#x2F;rancher&#x2F;cert 路径中\"></a>接着将域名证书放在 &#x2F; etc&#x2F;rancher&#x2F;cert 路径中</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cd</span> /tmp</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">tar -zxf cert.tgz</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">mkdir</span> -p /etc/rancher/cert</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">mv</span> fullchain.pem /etc/rancher/cert</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">mv</span> private.pem /etc/rancher/cert</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"然后创建-cattle-system-的命名空间和-tls-密钥\"><a href=\"#然后创建-cattle-system-的命名空间和-tls-密钥\" class=\"headerlink\" title=\"然后创建 cattle-system 的命名空间和 tls 密钥\"></a>然后创建 cattle-system 的命名空间和 tls 密钥</h3><figure class=\"highlight n1ql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"keyword\">create</span> <span class=\"keyword\">namespace</span> cattle-<span class=\"keyword\">system</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n cattle-<span class=\"keyword\">system</span> <span class=\"keyword\">create</span> secret tls tls-rancher-ingress </span><br><span class=\"line\">  --cert=/etc/rancher/cert/fullchain.pem </span><br><span class=\"line\">  --<span class=\"keyword\">key</span>=/etc/rancher/cert/<span class=\"keyword\">private</span>.pem</span><br></pre></td></tr></table></figure>\n<h3 id=\"最后安装-rancher-面板\"><a href=\"#最后安装-rancher-面板\" class=\"headerlink\" title=\"最后安装 rancher 面板\"></a>最后安装 rancher 面板</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm install rancher rancher-stable/rancher </span><br><span class=\"line\">  --namespace cattle-system </span><br><span class=\"line\">  --<span class=\"built_in\">set</span> <span class=\"attribute\">hostname</span>=cluster.domain.com </span><br><span class=\"line\">  --<span class=\"built_in\">set</span> <span class=\"attribute\">replicas</span>=3 </span><br><span class=\"line\">  --<span class=\"built_in\">set</span> ingress.tls.<span class=\"attribute\">source</span>=secret</span><br></pre></td></tr></table></figure>\n<p>等待 2 分钟后，执行命令获取登录信息，复制粘贴到浏览器打开进行初始化，访问前请先对域名进行解析。</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">echo</span> https://cluster.domain.<span class=\"keyword\">com</span>/dashboard/?setup=$(kubectl <span class=\"built_in\">get</span> secret --namespace cattle-<span class=\"built_in\">system</span> bootstrap-secret -<span class=\"keyword\">o</span> <span class=\"keyword\">go</span>-template=<span class=\"string\">&#x27;&#123;&#123;.data.bootstrapPassword|base64decode&#125;&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装部署-Longhorn-分布式存储\"><a href=\"#安装部署-Longhorn-分布式存储\" class=\"headerlink\" title=\"安装部署 Longhorn 分布式存储\"></a>安装部署 Longhorn 分布式存储</h2><p>完成上步对 rancher 部署后，进入左下角带齿轮图标的 Cluster Tools，找到 Longhorn 点击安装，一路默认点下一步就好，等待安装完成就好。</p>\n<h2 id=\"安装部署-velero-备份还原组件\"><a href=\"#安装部署-velero-备份还原组件\" class=\"headerlink\" title=\"安装部署 velero 备份还原组件\"></a>安装部署 velero 备份还原组件</h2><p>velero 是 k8s 下用于备份命名空间下容器的最佳利器，同样也适用于 k3s，以下为安装步骤</p>\n<h3 id=\"安装-velero\"><a href=\"#安装-velero\" class=\"headerlink\" title=\"安装 velero\"></a>安装 velero</h3><p>首先从官方 github 上下载软件进行安装，注意选择 arm64 的软件架构</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cd</span> /tmp</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">wget https://github.com/vmware-tanzu/velero/releases/download/v0/velero-v0-linux-armtar.gz</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">tar xvf velero-*-linux-*.tar.gz</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cd</span> velero-*-linux-*</span></span><br></pre></td></tr></table></figure>\n<p>复制到运行环境中，检查版本是否为目标版本</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cp velero /usr/local/bin/</span></span><br><span class=\"line\"><span class=\"comment\"># velero version --client-only</span></span><br><span class=\"line\"><span class=\"attribute\">Client</span>:</span><br><span class=\"line\">\t<span class=\"attribute\">Version</span>: v1.<span class=\"number\">9</span>.<span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"attribute\">Git</span> commit: <span class=\"number\">6021</span>f148c4d7721285e815a3e1af761262bff029</span><br></pre></td></tr></table></figure>\n<p>配置命令行自动补全</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;source &lt;(velero completion bash)&#x27;</span> &gt;&gt; ~/.bashrc</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">velero completion bash &gt; /etc/bash_completion.d/velero</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"配置-velero\"><a href=\"#配置-velero\" class=\"headerlink\" title=\"配置 velero\"></a>配置 velero</h3><p>velero 一般使用是搭配 s3 存储，然后定义好备份时间后，就会在时间到达的时候，自动备份到指定的 s3 存储，所以在配置 velero 之前，请先准备一个 s3 存储服务，可以说 aws 的 s3，也可以是自己搭建的 minio 服务，首先定义好 access_key 和 secret_key：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; credentials-velero &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[default]</span></span><br><span class=\"line\"><span class=\"string\">aws_access_key_id = fsjDhferKQCZnYtA9h8F</span></span><br><span class=\"line\"><span class=\"string\">aws_secret_access_key = Fw1Wch7fkS2iKS3S55j1LOxHindEllpOnjUIet2N</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p>然后定义环境变量，为该 s3 存储的位置信息和存储桶信息 (以下值根据你的服务情况而定)</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> <span class=\"attribute\">S3_CONFIG_BUCKET</span>=velero</span><br><span class=\"line\"><span class=\"built_in\">export</span> <span class=\"attribute\">S3_CONFIG_REGION</span>=eu-sto-1</span><br><span class=\"line\"><span class=\"built_in\">export</span> <span class=\"attribute\">S3_CONFIG_S3URL</span>=https://samaaws.com</span><br></pre></td></tr></table></figure>\n\n<p>然后开始安装，在这里需要定义 k3s 的 kubeconfig 文件，我遵从 k8s 的使用习惯，是将 rancher k3s 的配置信息写进本地家路径下的. kube&#x2F;config 中，实际情况你需要根据情况而进行修改</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">velero <span class=\"params\">--kubeconfig</span> <span class=\"string\">/root/.kube/config</span> install </span><br><span class=\"line\">    <span class=\"params\">--provider</span> aws </span><br><span class=\"line\">    <span class=\"params\">--plugins=velero/velero-plugin-for-aws</span><span class=\"function\">:v0</span> </span><br><span class=\"line\">    <span class=\"params\">--bucket</span> $&#123;S3_CONFIG_BUCKET&#125; </span><br><span class=\"line\">    <span class=\"params\">--secret-file</span> <span class=\"string\">./credentials-velero</span> </span><br><span class=\"line\">    <span class=\"params\">--use-volume-snapshots=false</span> </span><br><span class=\"line\">    <span class=\"params\">--use-restic</span> </span><br><span class=\"line\">    <span class=\"params\">--backup-location-config</span> region=$&#123;S3_CONFIG_REGION&#125;,s3ForcePathStyle=<span class=\"string\">&quot;true&quot;</span>,s3Url=$&#123;S3_CONFIG_S3URL&#125; <span class=\"params\">--prefix</span> velero</span><br></pre></td></tr></table></figure>\n<p>验证安装结果，如果有报错，可以在日志中看到的，执行命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs deployment/velero -n velero</span><br></pre></td></tr></table></figure>\n<h3 id=\"卸载-velero\"><a href=\"#卸载-velero\" class=\"headerlink\" title=\"卸载 velero\"></a>卸载 velero</h3><p>如果配置出错或不想使用 velero 进行备份了，可以非常方便地进行卸载操作，执行命令：</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">velero uninstall</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"使用-velero-进行单次备份\"><a href=\"#使用-velero-进行单次备份\" class=\"headerlink\" title=\"使用 velero 进行单次备份\"></a>使用 velero 进行单次备份</h3><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">velero backup <span class=\"built_in\">create</span> app<span class=\"number\">-1</span> </span><br><span class=\"line\">  <span class=\"comment\">--include-namespaces app </span></span><br><span class=\"line\">  <span class=\"comment\">--default-volumes-to-restic</span></span><br></pre></td></tr></table></figure>\n<p>简要说明：</p>\n<ol>\n<li>app-1 为本次备份的名称，方便后续查找和恢复，唯一</li>\n<li>–include-namespaces app : velero 遵从按命名空间进行备份，所有位于该命名空间下的资料都会被当成一个备份条件进行备份</li>\n<li>–default-volumes-to-restic : 开启这个选项后，就可以备份到 pvc 里面的内容了，就不仅仅是 yaml 配置信息，是完整的备份。</li>\n</ol>\n<p>tips：可以随时查看备份的详情，例如在备份进行中时，可以使用命令查看进度</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">velero backup <span class=\"keyword\">describe</span> <span class=\"keyword\">app</span>-1</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用-velero-进行循环定时备份\"><a href=\"#使用-velero-进行循环定时备份\" class=\"headerlink\" title=\"使用 velero 进行循环定时备份\"></a>使用 velero 进行循环定时备份</h3><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">velero schedule create app-12h </span><br><span class=\"line\">  <span class=\"params\">--include-namespaces</span> app </span><br><span class=\"line\">  <span class=\"params\">--default-volumes-to-restic</span> </span><br><span class=\"line\">  <span class=\"params\">--schedule=</span><span class=\"string\">&quot;@every 12h&quot;</span></span><br></pre></td></tr></table></figure>\n<p>简要说明：</p>\n<ol>\n<li>与单次备份不同，这里使用 schedule create，创建一个计划任务的方式创建备份任务</li>\n<li>–schedule : 定义了间隔时间，例如 @every 12h，代表间隔 12 小时备份一次，例如 @daily ，则为每日备份一次</li>\n</ol>\n<h3 id=\"使用-velero-进行还原\"><a href=\"#使用-velero-进行还原\" class=\"headerlink\" title=\"使用 velero 进行还原\"></a>使用 velero 进行还原</h3><p>还原操作适用于回档或进行迁移，首先在集群 b 安装好运行环境和 velero 后，配置好 s3 的信息，就可以执行命令获取备份列表：</p>\n<figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># velero backup get</span></span><br></pre></td></tr></table></figure>\n<p>执行恢复：</p>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">velero restore <span class=\"built_in\">create</span> <span class=\"comment\">--from-backup app-1</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"配置-ModSecurity\"><a href=\"#配置-ModSecurity\" class=\"headerlink\" title=\"配置 ModSecurity\"></a>配置 ModSecurity</h2><p>在 nginx-ingress 中，默认已经包含 ModSecurity 的库，并也有 OWASP 的规则，只是默认情况下没有开启，我们可以在 ingress-nginx 的 configmaps 里，添加配置开启这部分的功能</p>\n<figure class=\"highlight scilab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl patch configmaps -n ingress-nginx ingress-nginx-controller -p <span class=\"string\">&#x27;&#123;&quot;</span>data<span class=\"string\">&quot;:&#123; &quot;</span>brotli-level<span class=\"string\">&quot;: &quot;</span><span class=\"number\">4</span><span class=\"string\">&quot;,&quot;</span>compute-full-forwarded-<span class=\"keyword\">for</span><span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>enable-brotli<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>enable-modsecurity<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>enable-ocsp<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>enable-owasp-modsecurity-crs<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>enable-<span class=\"built_in\">real</span>-ip<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>forwarded-<span class=\"keyword\">for</span>-header<span class=\"string\">&quot;: &quot;</span>X-Forwarded-For<span class=\"string\">&quot;,&quot;</span>gzip-level<span class=\"string\">&quot;: &quot;</span><span class=\"number\">4</span><span class=\"string\">&quot;,&quot;</span><span class=\"built_in\">max</span>-worker-connections<span class=\"string\">&quot;: &quot;</span><span class=\"number\">65535</span><span class=\"string\">&quot;,&quot;</span>modsecurity-snippet<span class=\"string\">&quot;: &quot;</span>SecRuleEngine On\\\\n<span class=\"string\">&quot;,&quot;</span>proxy-add-original-uri-header<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>proxy-body-<span class=\"built_in\">size</span><span class=\"string\">&quot;: &quot;</span><span class=\"number\">0</span><span class=\"string\">&quot;,&quot;</span>ssl-buffer-<span class=\"built_in\">size</span><span class=\"string\">&quot;: &quot;</span><span class=\"number\">16</span>k<span class=\"string\">&quot;,&quot;</span>use-forwarded-headers<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>use-gzip<span class=\"string\">&quot;: &quot;</span>true<span class=\"string\">&quot;,&quot;</span>worker-cpu-affinity<span class=\"string\">&quot;: &quot;</span>auto<span class=\"string\">&quot;,&quot;</span>worker-processes<span class=\"string\">&quot;: &quot;</span>auto<span class=\"string\">&quot;,&quot;</span>worker-rlimit-nofile<span class=\"string\">&quot;: &quot;</span><span class=\"number\">300000</span><span class=\"string\">&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>这里开启后会对所有 ingress 都起作用，如果不需要 modsecurity 的，注意可以不用理会这条，不必修改就好</p>\n<p>开启 modsecurity 之后的朋友，还需要对 rancher 的 ingress，关闭功能，防止一些莫名其妙的控制面板报错</p>\n<figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl patch ingress -n cattle-system rancher -p &#x27;&#123;&quot;<span class=\"attribute\">metadata&quot;</span>: &#123;&quot;annotations&quot;: &#123;&quot;nginx<span class=\"variable\">.ingress</span><span class=\"variable\">.kubernetes</span><span class=\"variable\">.io</span>/enable-modsecurity&quot;: &quot;false&quot;,&quot;nginx<span class=\"variable\">.ingress</span><span class=\"variable\">.kubernetes</span><span class=\"variable\">.io</span>/enable-owasp-core-rules&quot;: &quot;false&quot;,&quot;nginx<span class=\"variable\">.ingress</span><span class=\"variable\">.kubernetes</span><span class=\"variable\">.io</span>/modsecurity-snippet&quot;: &quot;SecRuleEngine Off\\\\n&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装-Cert-manager-管理证书\"><a href=\"#安装-Cert-manager-管理证书\" class=\"headerlink\" title=\"安装 Cert-manager 管理证书\"></a>安装 Cert-manager 管理证书</h2><p>直接 kubectl 一把梭了，执行：</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https:<span class=\"regexp\">//gi</span>thub.com<span class=\"regexp\">/cert-manager/</span>cert-manager<span class=\"regexp\">/releases/</span>download<span class=\"regexp\">/v1.8.2/</span>cert-manager.yaml</span><br></pre></td></tr></table></figure>\n<p>然后给需要分配证书的 ns 分配发行者，这里我们直接用 letsencrypt 提供的证书，太方便了</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl -n icodex create -f - &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span><span class=\"punctuation\">:</span> <span class=\"string\">cert-manager.io/v1</span></span><br><span class=\"line\"><span class=\"attribute\">kind</span><span class=\"punctuation\">:</span> <span class=\"string\">Issuer</span></span><br><span class=\"line\"><span class=\"attribute\">metadata</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">letsencrypt-prod</span></span><br><span class=\"line\">  <span class=\"attribute\">namespace</span><span class=\"punctuation\">:</span> <span class=\"string\">icodex</span></span><br><span class=\"line\"><span class=\"attribute\">spec</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">acme</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">    <span class=\"attribute\">email</span><span class=\"punctuation\">:</span> <span class=\"string\">icodex@msn.com</span></span><br><span class=\"line\">    <span class=\"attribute\">privateKeySecretRef</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">      <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">letsencrypt-prod</span></span><br><span class=\"line\">    <span class=\"attribute\">server</span><span class=\"punctuation\">:</span> <span class=\"string\">https://acme-vapi.letsencrypt.org/directory</span></span><br><span class=\"line\">    <span class=\"attribute\">solvers</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">http01:</span></span><br><span class=\"line\">        <span class=\"attribute\">ingress</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">          <span class=\"attribute\">class</span><span class=\"punctuation\">:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>然后给域名分配证书</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl -n icodex create -f - &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span><span class=\"punctuation\">:</span> <span class=\"string\">cert-manager.io/v1</span></span><br><span class=\"line\"><span class=\"attribute\">kind</span><span class=\"punctuation\">:</span> <span class=\"string\">Certificate</span></span><br><span class=\"line\"><span class=\"attribute\">metadata</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">web-domain-com</span></span><br><span class=\"line\">  <span class=\"attribute\">namespace</span><span class=\"punctuation\">:</span> <span class=\"string\">icodex</span></span><br><span class=\"line\"><span class=\"attribute\">spec</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">secretName</span><span class=\"punctuation\">:</span> <span class=\"string\">web-domain-com-tls</span></span><br><span class=\"line\">  <span class=\"attribute\">duration</span><span class=\"punctuation\">:</span> <span class=\"string\">2160h</span></span><br><span class=\"line\">  <span class=\"attribute\">renewBefore</span><span class=\"punctuation\">:</span> <span class=\"string\">360h</span></span><br><span class=\"line\">  <span class=\"attribute\">commonName</span><span class=\"punctuation\">:</span> <span class=\"string\">web.domain.com</span></span><br><span class=\"line\">  <span class=\"attribute\">isCA</span><span class=\"punctuation\">:</span> <span class=\"string\">false</span></span><br><span class=\"line\">  <span class=\"attribute\">privateKey</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">    <span class=\"attribute\">algorithm</span><span class=\"punctuation\">:</span> <span class=\"string\">RSA</span></span><br><span class=\"line\">    <span class=\"attribute\">encoding</span><span class=\"punctuation\">:</span> <span class=\"string\">PKCS1</span></span><br><span class=\"line\">    <span class=\"attribute\">size</span><span class=\"punctuation\">:</span> <span class=\"string\">2048</span></span><br><span class=\"line\">  <span class=\"attribute\">dnsNames</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">web.domain.com</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">app.domain.com</span></span><br><span class=\"line\">  <span class=\"attribute\">issuerRef</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">    <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">letsencrypt-prod</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>等待数分钟后，或者通过命令查询证书分配情况，当看到 Type:Ready 时，即代表证书已经申请成功，回到 ingress 那里，给域名指定一个证书就可以了。</p>\n<p>至此安装完毕，所有 pod 如下：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubectl get po -A</span></span><br><span class=\"line\"><span class=\"attribute\">NAMESPACE</span>                   NAME                                                     READY   STATUS    RESTARTS       AGE</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-fleet-local-system   fleet-agent-<span class=\"number\">57497</span>ff7dc-b8kl5                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h12m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-fleet-system         fleet-controller-<span class=\"number\">5746685958</span>-szdjn                        <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h13m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-fleet-system         gitjob-cc9948fd7-xzb75                                   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h13m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    alertmanager-rancher-monitoring-alertmanager-<span class=\"number\">0</span>           <span class=\"number\">2</span>/<span class=\"number\">2</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    prometheus-rancher-monitoring-prometheus-<span class=\"number\">0</span>               <span class=\"number\">3</span>/<span class=\"number\">3</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    pushprox-k3s-server-client-<span class=\"number\">5</span>gck9                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    pushprox-k3s-server-client-hhfj8                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    pushprox-k3s-server-client-pgrbh                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    pushprox-k3s-server-proxy-f4f5d4874-gfkmc                <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    rancher-monitoring-grafana-<span class=\"number\">57777</span>cc795-<span class=\"number\">2</span>pzs6              <span class=\"number\">3</span>/<span class=\"number\">3</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    rancher-monitoring-kube-state-metrics-<span class=\"number\">5</span>bc8bb48bd-jmb2j   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    rancher-monitoring-operator-f79dc4944-lg8m8              <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    rancher-monitoring-prometheus-adapter-<span class=\"number\">8846</span>d4757-qcjcd    <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    rancher-monitoring-prometheus-node-exporter-hq82r        <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    rancher-monitoring-prometheus-node-exporter-mmp8n        <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-monitoring-system    rancher-monitoring-prometheus-node-exporter-z99jt        <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h7m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-system               rancher-<span class=\"number\">7649</span>d589ff-gj894                                 <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h14m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-system               rancher-<span class=\"number\">7649</span>d589ff-mm5jx                                 <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h14m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-system               rancher-<span class=\"number\">7649</span>d589ff-xfcm7                                 <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h14m</span><br><span class=\"line\"><span class=\"attribute\">cattle</span>-system               rancher-webhook-<span class=\"number\">6958</span>cfcddf-xhqwk                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h12m</span><br><span class=\"line\"><span class=\"attribute\">cert</span>-manager                cert-manager-<span class=\"number\">66</span>b646d76-qmxms                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">165</span>m</span><br><span class=\"line\"><span class=\"attribute\">cert</span>-manager                cert-manager-cainjector-<span class=\"number\">59</span>dc9659c7-tzhzm                 <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">165</span>m</span><br><span class=\"line\"><span class=\"attribute\">cert</span>-manager                cert-manager-webhook-<span class=\"number\">7</span>d8f555998-kh5zl                    <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">165</span>m</span><br><span class=\"line\"><span class=\"attribute\">icodex</span>                      nginx-<span class=\"number\">6</span>dd7b9db9b-<span class=\"number\">79</span>rdp                                   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">178</span>m</span><br><span class=\"line\"><span class=\"attribute\">icodex</span>                      nginx-<span class=\"number\">6</span>dd7b9db9b-cs2tm                                   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">178</span>m</span><br><span class=\"line\"><span class=\"attribute\">icodex</span>                      nginx-<span class=\"number\">6</span>dd7b9db9b-w94d8                                   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">178</span>m</span><br><span class=\"line\"><span class=\"attribute\">icodex</span>                      php-fpm-<span class=\"number\">5</span>c5758b88-<span class=\"number\">7</span>tcqx                                  <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">178</span>m</span><br><span class=\"line\"><span class=\"attribute\">icodex</span>                      php-fpm-<span class=\"number\">5</span>c5758b88-kw4pp                                  <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">178</span>m</span><br><span class=\"line\"><span class=\"attribute\">icodex</span>                      php-fpm-<span class=\"number\">5</span>c5758b88-pgg7n                                  <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">178</span>m</span><br><span class=\"line\"><span class=\"attribute\">ingress</span>-nginx               ingress-nginx-controller-<span class=\"number\">5</span>b7cf87848-dnbt8                <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h31m</span><br><span class=\"line\"><span class=\"attribute\">ingress</span>-nginx               svclb-ingress-nginx-controller-<span class=\"number\">9</span>fdqg                     <span class=\"number\">2</span>/<span class=\"number\">2</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h31m</span><br><span class=\"line\"><span class=\"attribute\">ingress</span>-nginx               svclb-ingress-nginx-controller-dglh6                     <span class=\"number\">2</span>/<span class=\"number\">2</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h31m</span><br><span class=\"line\"><span class=\"attribute\">ingress</span>-nginx               svclb-ingress-nginx-controller-szs9s                     <span class=\"number\">2</span>/<span class=\"number\">2</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h31m</span><br><span class=\"line\"><span class=\"attribute\">kube</span>-system                 coredns-<span class=\"number\">7796</span>b77cd4-b5gwb                                 <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">5</span>h16m</span><br><span class=\"line\"><span class=\"attribute\">kube</span>-system                 kilo-<span class=\"number\">5</span>khs9                                               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">5</span>h5m</span><br><span class=\"line\"><span class=\"attribute\">kube</span>-system                 kilo-<span class=\"number\">8574</span>c                                               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">5</span>h3m</span><br><span class=\"line\"><span class=\"attribute\">kube</span>-system                 kilo-jqw5f                                               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">5</span>h12m</span><br><span class=\"line\"><span class=\"attribute\">kube</span>-system                 local-path-provisioner-<span class=\"number\">84</span>bb864455-<span class=\"number\">85</span>dtg                  <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">5</span>h16m</span><br><span class=\"line\"><span class=\"attribute\">kube</span>-system                 metrics-server-ff9dbcb6c-jk5v2                           <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">5</span>h16m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-attacher-<span class=\"number\">8</span>b4cc9cf6-dj55n                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-attacher-<span class=\"number\">8</span>b4cc9cf6-mj78z                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-attacher-<span class=\"number\">8</span>b4cc9cf6-n8v7v                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-provisioner-<span class=\"number\">59</span>b7b8b7b8-<span class=\"number\">5</span>skdn                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-provisioner-<span class=\"number\">59</span>b7b8b7b8-tddz2                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-provisioner-<span class=\"number\">59</span>b7b8b7b8-xqzjp                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-resizer-<span class=\"number\">68</span>ccff94-gh9fx                               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-resizer-<span class=\"number\">68</span>ccff94-lxlst                               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-resizer-<span class=\"number\">68</span>ccff94-rkftz                               <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-snapshotter-<span class=\"number\">6</span>d7d679c98-<span class=\"number\">477</span>s4                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-snapshotter-<span class=\"number\">6</span>d7d679c98-bt9ww                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             csi-snapshotter-<span class=\"number\">6</span>d7d679c98-qkcff                         <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             engine-image-ei-d474e07c-<span class=\"number\">2</span>nk6r                           <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             engine-image-ei-d474e07c-jqsgl                           <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             engine-image-ei-d474e07c-vh48h                           <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             instance-manager-e-<span class=\"number\">8</span>b411f4a                              <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             instance-manager-e-da92c7e5                              <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             instance-manager-e-fb0588b7                              <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             instance-manager-r-<span class=\"number\">5</span>c615480                              <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             instance-manager-r-<span class=\"number\">9</span>e4dac9d                              <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             instance-manager-r-cfd922a1                              <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-csi-plugin-fmc6b                                <span class=\"number\">2</span>/<span class=\"number\">2</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-csi-plugin-g62hj                                <span class=\"number\">2</span>/<span class=\"number\">2</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-csi-plugin-k7mlz                                <span class=\"number\">2</span>/<span class=\"number\">2</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h8m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-driver-deployer-<span class=\"number\">7</span>ffd665594-<span class=\"number\">2</span>q8rm                <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h9m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-manager-<span class=\"number\">55</span>hjs                                   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (<span class=\"number\">3</span>h8m ago)   <span class=\"number\">3</span>h9m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-manager-mdtn2                                   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (<span class=\"number\">3</span>h8m ago)   <span class=\"number\">3</span>h9m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-manager-twg2m                                   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h9m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             longhorn-ui-<span class=\"number\">556866</span>b6bb-<span class=\"number\">6</span>wpb7                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h9m</span><br><span class=\"line\"><span class=\"attribute\">longhorn</span>-system             share-manager-pvc-<span class=\"number\">7</span>a347acd-b8e8-<span class=\"number\">44</span>df-a2c0-<span class=\"number\">4</span>b4ec54d84fc   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">3</span>h4m</span><br><span class=\"line\"><span class=\"attribute\">velero</span>                      restic-<span class=\"number\">8</span>qkjv                                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">156</span>m</span><br><span class=\"line\"><span class=\"attribute\">velero</span>                      restic-b9nfn                                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">156</span>m</span><br><span class=\"line\"><span class=\"attribute\">velero</span>                      restic-jmt9n                                             <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">156</span>m</span><br><span class=\"line\"><span class=\"attribute\">velero</span>                      velero-<span class=\"number\">79</span>fd55b75d-q68lm                                  <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>              <span class=\"number\">156</span>m</span><br></pre></td></tr></table></figure>\n<p>最后是完成后的一些图片，目前已经稳定运行半个月。</p>\n<p><img src=\"https://raw.githubusercontent.com/dandeliono/img/main/resource/e280eb710ac358722c12b8dbf4654c49.jpeg\"></p>\n<p><img src=\"https://raw.githubusercontent.com/dandeliono/img/main/resource/b18ac6a32bdf7798a41937ec1422119d.jpeg\"></p>\n<p><img src=\"https://raw.githubusercontent.com/dandeliono/img/main/resource/364f9d36084e9bd886ea141d7fc0907e.webp\"></p>\n<p>后记：Arm 架构的服务器在几个大厂的推动下，取得不错的成绩，在程序方面也有许多开发者做了这部分的兼容，使用起来是没有问题的。未来以 arm 为代表的精简指令集的 soc 必将在服务器领域取得不错的成绩的。</p>\n","text":"使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份申请 Oracle甲骨文的Arm实例已经很久了，甲骨文的配置...","permalink":"/post/OCI/使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份","photos":[],"count_time":{"symbolsCount":"25k","symbolsTime":"23 mins."},"categories":[{"name":"velero","slug":"velero","count":1,"path":"api/categories/velero.json"},{"name":"OCI","slug":"velero/OCI","count":1,"path":"api/categories/velero/OCI.json"}],"tags":[{"name":"https","slug":"https","count":44,"path":"api/tags/https.json"},{"name":"server","slug":"server","count":3,"path":"api/tags/server.json"},{"name":"ingress","slug":"ingress","count":1,"path":"api/tags/ingress.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8K3S-Kilo%E9%83%A8%E7%BD%B2%E5%AE%89%E5%85%A8%E5%A4%9A%E5%8C%BA%E4%BA%91%E5%8E%9F%E7%94%9FARM%E9%9B%86%E7%BE%A4%EF%BC%8C%E6%94%AF%E6%8C%81nginx-ingress%E5%8F%8Avelero%E5%A4%87%E4%BB%BD\"><span class=\"toc-text\">使用K3S+ Kilo部署安全多区云原生ARM集群，支持nginx-ingress及velero备份</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-Wireguard-%E7%BB%84%E5%B1%80%E5%9F%9F%E7%BD%91\"><span class=\"toc-text\">使用 Wireguard 组局域网</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-wireguard\"><span class=\"toc-text\">安装 wireguard</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-k3s-server-%E8%8A%82%E7%82%B9\"><span class=\"toc-text\">安装部署 k3s server 节点</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-Kilo-CNI-%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6\"><span class=\"toc-text\">安装 Kilo CNI 网络组件</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91\"><span class=\"toc-text\">网络拓扑</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-Kilo-CNI-%E7%BB%84%E4%BB%B6\"><span class=\"toc-text\">安装 Kilo CNI 组件</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%AA%8C%E8%AF%81-Kilo-%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">验证 Kilo 安装</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-k3s-agent-%E8%8A%82%E7%82%B9\"><span class=\"toc-text\">安装部署 k3s agent 节点</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Kilo-CNI-%E7%9A%84%E7%BD%91%E5%8D%A1%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">Kilo CNI 的网卡说明</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BD%91%E5%8D%A1%E5%88%97%E8%A1%A8\"><span class=\"toc-text\">网卡列表</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B7%AF%E7%94%B1%E8%A1%A8\"><span class=\"toc-text\">路由表</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-helm-%E9%83%A8%E7%BD%B2%E8%BD%AF%E4%BB%B6\"><span class=\"toc-text\">安装 helm 部署软件</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-nginx-ingress\"><span class=\"toc-text\">安装部署 nginx-ingress</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-rancher-%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9D%BF\"><span class=\"toc-text\">安装部署 rancher 控制面板</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%A6%96%E5%85%88%E6%B7%BB%E5%8A%A0-helm-%E7%9A%84-repo\"><span class=\"toc-text\">首先添加 helm 的 repo</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%8E%A5%E7%9D%80%E5%B0%86%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6%E6%94%BE%E5%9C%A8-x2F-etc-x2F-rancher-x2F-cert-%E8%B7%AF%E5%BE%84%E4%B8%AD\"><span class=\"toc-text\">接着将域名证书放在 &#x2F; etc&#x2F;rancher&#x2F;cert 路径中</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%84%B6%E5%90%8E%E5%88%9B%E5%BB%BA-cattle-system-%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%92%8C-tls-%E5%AF%86%E9%92%A5\"><span class=\"toc-text\">然后创建 cattle-system 的命名空间和 tls 密钥</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%80%E5%90%8E%E5%AE%89%E8%A3%85-rancher-%E9%9D%A2%E6%9D%BF\"><span class=\"toc-text\">最后安装 rancher 面板</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-Longhorn-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8\"><span class=\"toc-text\">安装部署 Longhorn 分布式存储</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-velero-%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F%E7%BB%84%E4%BB%B6\"><span class=\"toc-text\">安装部署 velero 备份还原组件</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-velero\"><span class=\"toc-text\">安装 velero</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE-velero\"><span class=\"toc-text\">配置 velero</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8D%B8%E8%BD%BD-velero\"><span class=\"toc-text\">卸载 velero</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-velero-%E8%BF%9B%E8%A1%8C%E5%8D%95%E6%AC%A1%E5%A4%87%E4%BB%BD\"><span class=\"toc-text\">使用 velero 进行单次备份</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-velero-%E8%BF%9B%E8%A1%8C%E5%BE%AA%E7%8E%AF%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD\"><span class=\"toc-text\">使用 velero 进行循环定时备份</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-velero-%E8%BF%9B%E8%A1%8C%E8%BF%98%E5%8E%9F\"><span class=\"toc-text\">使用 velero 进行还原</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE-ModSecurity\"><span class=\"toc-text\">配置 ModSecurity</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-Cert-manager-%E7%AE%A1%E7%90%86%E8%AF%81%E4%B9%A6\"><span class=\"toc-text\">安装 Cert-manager 管理证书</span></a></li></ol></li></ol>","author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Logstash性能调优","uid":"f4f318f964064d6dbbbf9f460a2ebe37","slug":"MIDDLEWARE/Logstash性能调优","date":"2022-08-03T15:53:32.000Z","updated":"2025-12-05T01:47:29.448Z","comments":true,"path":"api/articles/MIDDLEWARE/Logstash性能调优.json","keywords":"XuGuangSheng","cover":"/covers/logstash.jpg","text":"Logstash性能调优详细调优参考 Inputs 和 Outputs 的性能当输入输出源的性能已经达到上限，那么性能瓶颈不在 Logstash，应优先对输入输...","permalink":"/post/MIDDLEWARE/Logstash性能调优","photos":[],"count_time":{"symbolsCount":"1.3k","symbolsTime":"1 mins."},"categories":[{"name":"Inputs","slug":"Inputs","count":1,"path":"api/categories/Inputs.json"},{"name":"MIDDLEWARE","slug":"Inputs/MIDDLEWARE","count":1,"path":"api/categories/Inputs/MIDDLEWARE.json"}],"tags":[{"name":"Outputs","slug":"Outputs","count":1,"path":"api/tags/Outputs.json"},{"name":"的性能","slug":"的性能","count":1,"path":"api/tags/的性能.json"},{"name":"系统性能指标","slug":"系统性能指标","count":1,"path":"api/tags/系统性能指标.json"}],"author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"应对掘金CDN开启防盗链 记一次爬取markdown图片的经历","uid":"fcfa6f5ea8dabe903d8fbcda021fdf5f","slug":"WORK/应对掘金CDN开启防盗链 记一次爬取markdown图片的经历","date":"2022-07-29T14:06:36.000Z","updated":"2025-12-05T01:48:08.550Z","comments":true,"path":"api/articles/WORK/应对掘金CDN开启防盗链 记一次爬取markdown图片的经历.json","keywords":"XuGuangSheng","cover":"/covers/cdn-markdown.jpg","text":"应对掘金CDN开启防盗链 记一次爬取markdown图片的经历使用 markdown 写文章有什么好处? markdown 是一种纯文本格式 (后缀.md), ...","permalink":"/post/WORK/应对掘金CDN开启防盗链 记一次爬取markdown图片的经历","photos":[],"count_time":{"symbolsCount":"7.4k","symbolsTime":"7 mins."},"categories":[{"name":"github","slug":"github","count":1,"path":"api/categories/github.json"},{"name":"WORK","slug":"github/WORK","count":1,"path":"api/categories/github/WORK.json"}],"tags":[{"name":"https","slug":"https","count":44,"path":"api/tags/https.json"},{"name":"com","slug":"com","count":26,"path":"api/tags/com.json"},{"name":"png","slug":"png","count":2,"path":"api/tags/png.json"}],"author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}