{"title":"常见的bpftrace脚本","uid":"deb7ca296fb4175b782a15a32d428fc0","slug":"LINUX/常见的bpftrace脚本","date":"2025-08-05T17:34:11.000Z","updated":"2025-09-30T03:26:42.924Z","comments":true,"path":"api/articles/LINUX/常见的bpftrace脚本.json","keywords":"XuGuangSheng","cover":"/covers/bpftrace.jpg","content":"<h1 id=\"常见的bpftrace脚本\"><a href=\"#常见的bpftrace脚本\" class=\"headerlink\" title=\"常见的bpftrace脚本\"></a>常见的bpftrace脚本</h1><h2 id=\"跟踪-tracepoint-kfree-skb-​\"><a href=\"#跟踪-tracepoint-kfree-skb-​\" class=\"headerlink\" title=\"跟踪 tracepoint kfree_skb ​\"></a>跟踪 tracepoint kfree_skb <a href=\"#%E8%B7%9F%E8%B8%AA-tracepoint-kfree-skb\">​</a></h2><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/bpftrace</span></span><br><span class=\"line\">tracepoint:skb:kfree_skb &#123;</span><br><span class=\"line\"> $skb = (struct sk_buff *)args-&gt;skbaddr;</span><br><span class=\"line\"> $iph = (struct iphdr *)($skb-&gt;head + $skb-&gt;network_header);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($iph-&gt;protocol == IPPROTO_ICMP) &#123;</span><br><span class=\"line\"> $icmph = (struct icmphdr *)($skb-&gt;head + $skb-&gt;transport_header);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;TIME:%s PID/TID: %d/%d &quot;</span>, strftime(<span class=\"string\">&quot;%H:%M:%S:%f&quot;</span>, nsecs), pid, tid);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;COMM: %s DEV: %s\\n&quot;</span>, comm, $skb-&gt;dev-&gt;name);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;ICMP %s-&gt;%s &quot;</span>, ntop($iph-&gt;saddr), ntop($iph-&gt;daddr));</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;id:%d seq:%d &quot;</span>, bswap($icmph-&gt;un.echo.id), bswap($icmph-&gt;un.echo.sequence));</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;\\n\\n&quot;</span>);</span><br><span class=\"line\"> <span class=\"regexp\">//</span> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;%s&quot;</span>, kstack);</span><br><span class=\"line\"> &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ($iph-&gt;protocol == IPPROTO_TCP) &#123;</span><br><span class=\"line\"> $tcph = (struct tcphdr *)($skb-&gt;head + $skb-&gt;transport_header);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;TIME:%s PID/TID: %d/%d &quot;</span>, strftime(<span class=\"string\">&quot;%H:%M:%S:%f&quot;</span>, nsecs), pid, tid);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;COMM: %s DEV: %s \\n&quot;</span>, comm, $skb-&gt;dev-&gt;name);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;TCP %s:%d&quot;</span>, ntop($iph-&gt;saddr), bswap($tcph-&gt;source));</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot; -&gt; %s:%d &quot;</span>, ntop($iph-&gt;daddr), bswap($tcph-&gt;dest));</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;FLAGS: [&quot;</span>);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;syn) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;S&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;fin) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;F&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;rst) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;R&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;psh) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;P&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;ack) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;.&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;] &quot;</span>);</span><br><span class=\"line\"> $seq = bswap($tcph-&gt;seq);</span><br><span class=\"line\"> $ack = bswap($tcph-&gt;ack_seq);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;SEQ: %ld ACK: %ld &quot;</span>, $seq, $ack);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;\\n\\n&quot;</span>);</span><br><span class=\"line\"> <span class=\"regexp\">//</span> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;%s&quot;</span>, kstack);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"跟踪-tcp-reset-​\"><a href=\"#跟踪-tcp-reset-​\" class=\"headerlink\" title=\"跟踪 tcp reset ​\"></a>跟踪 tcp reset <a href=\"#%E8%B7%9F%E8%B8%AA-tcp-reset\">​</a></h2><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/bpftrace</span></span><br><span class=\"line\"><span class=\"comment\">#define AF_INET   2</span></span><br><span class=\"line\"><span class=\"comment\">#define AF_INET6 10</span></span><br><span class=\"line\">kprobe:tcp_v4_send_reset &#123;</span><br><span class=\"line\"> $sk = (struct sock *)arg<span class=\"number\">0</span>;</span><br><span class=\"line\"> $skb = (struct sk_buff *)arg1;</span><br><span class=\"line\"> $iph = (struct iphdr *)($skb-&gt;head + $skb-&gt;network_header);</span><br><span class=\"line\"> <span class=\"regexp\">//</span> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;%p %p %d\\n&quot;</span>, $skb, $skb-&gt;head, $skb-&gt;network_header);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($iph-&gt;protocol == IPPROTO_TCP) &#123;</span><br><span class=\"line\"> $tcph = (struct tcphdr *)($skb-&gt;head + $skb-&gt;transport_header);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;PASSIVE RESET TIME:%s PID/TID: %d/%d &quot;</span>, strftime(<span class=\"string\">&quot;%H:%M:%S:%f&quot;</span>, nsecs), pid, tid);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;COMM: %s DEV: %s \\n&quot;</span>, comm, $skb-&gt;dev-&gt;name);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;TCP %s:%d&quot;</span>, ntop($iph-&gt;saddr), bswap($tcph-&gt;source));</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot; -&gt; %s:%d &quot;</span>, ntop($iph-&gt;daddr), bswap($tcph-&gt;dest));</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;FLAGS: [&quot;</span>);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;syn) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;S&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;fin) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;F&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;rst) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;R&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;psh) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;P&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($tcph-&gt;ack) &#123;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;.&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;] &quot;</span>);</span><br><span class=\"line\"> $seq = bswap($tcph-&gt;seq);</span><br><span class=\"line\"> $ack = bswap($tcph-&gt;ack_seq);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;SEQ: %ld ACK: %ld &quot;</span>, $seq, $ack);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;\\n\\n&quot;</span>);</span><br><span class=\"line\"> <span class=\"regexp\">//</span> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;%s&quot;</span>, kstack);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">kprobe:tcp_send_active_reset &#123;</span><br><span class=\"line\"> $sk = (struct sock *)arg<span class=\"number\">0</span>;</span><br><span class=\"line\"> $lport = $sk-&gt;__sk_common.skc_num;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;%d %d\\n&quot;</span>, $lport, $sk-&gt;__sk_common.skc_num);</span><br><span class=\"line\"> $dport = $sk-&gt;__sk_common.skc_dport;</span><br><span class=\"line\"> $dport = bswap($dport);</span><br><span class=\"line\"> $family = $sk-&gt;__sk_common.skc_family;</span><br><span class=\"line\"> $saddr = ntop(<span class=\"number\">0</span>);</span><br><span class=\"line\"> $daddr = ntop(<span class=\"number\">0</span>);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ($family == AF_INET) &#123;</span><br><span class=\"line\"> $saddr = ntop(AF_INET, $sk-&gt;__sk_common.skc_rcv_saddr);</span><br><span class=\"line\"> $daddr = ntop(AF_INET, $sk-&gt;__sk_common.skc_daddr);</span><br><span class=\"line\"> &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"> <span class=\"regexp\">//</span> AF_INET6</span><br><span class=\"line\"> $saddr = ntop(AF_INET6,</span><br><span class=\"line\"> $sk-&gt;__sk_common.skc_v6_rcv_saddr.in6_u.u6_addr8);</span><br><span class=\"line\"> $daddr = ntop(AF_INET6,</span><br><span class=\"line\"> $sk-&gt;__sk_common.skc_v6_daddr.in6_u.u6_addr8);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;ACTIVE RESET TIME:%s PID/TID: %d/%d &quot;</span>, strftime(<span class=\"string\">&quot;%H:%M:%S:%f&quot;</span>, nsecs), pid, tid);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;%s:%d -&gt; %s:%d&quot;</span>, $saddr, $lport, $daddr, $dport);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;\\n\\n&quot;</span>);</span><br><span class=\"line\"> <span class=\"keyword\">printf</span>(<span class=\"string\">&quot;%s&quot;</span>, kstack);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","feature":true,"text":"常见的bpftrace脚本跟踪 tracepoint kfree_skb ​123456789101112131415161718192021222324252...","permalink":"/post/LINUX/常见的bpftrace脚本","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[{"name":"跟踪","slug":"跟踪","count":1,"path":"api/categories/跟踪.json"},{"name":"LINUX","slug":"跟踪/LINUX","count":1,"path":"api/categories/跟踪/LINUX.json"}],"tags":[{"name":"tracepoint","slug":"tracepoint","count":1,"path":"api/tags/tracepoint.json"},{"name":"kfree","slug":"kfree","count":1,"path":"api/tags/kfree.json"},{"name":"skb","slug":"skb","count":1,"path":"api/tags/skb.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%B8%B8%E8%A7%81%E7%9A%84bpftrace%E8%84%9A%E6%9C%AC\"><span class=\"toc-text\">常见的bpftrace脚本</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%B7%9F%E8%B8%AA-tracepoint-kfree-skb-%E2%80%8B\"><span class=\"toc-text\">跟踪 tracepoint kfree_skb </span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%B7%9F%E8%B8%AA-tcp-reset-%E2%80%8B\"><span class=\"toc-text\">跟踪 tcp reset </span></a></li></ol></li></ol>","author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"定制Ubuntu安装镜像的两种方法","uid":"4944cfccd2356072e58570e06c390077","slug":"LINUX/定制Ubuntu安装镜像的两种方法","date":"2025-08-07T16:44:08.000Z","updated":"2025-09-30T03:26:42.687Z","comments":true,"path":"api/articles/LINUX/定制Ubuntu安装镜像的两种方法.json","keywords":"XuGuangSheng","cover":"/covers/ubuntu.jpg","text":"定制Ubuntu安装镜像的两种方法1. 准备工作1234- 确保你有一个Ubuntu工作站或虚拟机来进行定制工作。- 确保你的系统已经更新： ```bash s...","permalink":"/post/LINUX/定制Ubuntu安装镜像的两种方法","photos":[],"count_time":{"symbolsCount":"2.8k","symbolsTime":"3 mins."},"categories":[{"name":"ISO","slug":"ISO","count":1,"path":"api/categories/ISO.json"},{"name":"LINUX","slug":"ISO/LINUX","count":1,"path":"api/categories/ISO/LINUX.json"}],"tags":[{"name":"sudo","slug":"sudo","count":1,"path":"api/tags/sudo.json"},{"name":"bash","slug":"bash","count":1,"path":"api/tags/bash.json"},{"name":"Cubic","slug":"Cubic","count":1,"path":"api/tags/Cubic.json"}],"author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"Linux etc shadow 文件学习笔记","uid":"7c083edc735a96bb85e82e86710ce6ee","slug":"LINUX/Linux etc shadow 文件学习笔记","date":"2025-08-05T17:33:14.000Z","updated":"2025-09-30T03:26:31.741Z","comments":true,"path":"api/articles/LINUX/Linux etc shadow 文件学习笔记.json","keywords":"XuGuangSheng","cover":"/covers/linux-etc-shadow.jpg","text":"Linux /etc/shadow 文件学习笔记Linux系统下，创建的用户信息如ID，家目录，默认shell保存在/etc/passwd下，该文件每行的第二位...","permalink":"/post/LINUX/Linux etc shadow 文件学习笔记","photos":[],"count_time":{"symbolsCount":"6.1k","symbolsTime":"6 mins."},"categories":[{"name":"etc","slug":"etc","count":2,"path":"api/categories/etc.json"},{"name":"LINUX","slug":"etc/LINUX","count":2,"path":"api/categories/etc/LINUX.json"}],"tags":[{"name":"通过","slug":"通过","count":2,"path":"api/tags/通过.json"},{"name":"chage","slug":"chage","count":1,"path":"api/tags/chage.json"},{"name":"user","slug":"user","count":1,"path":"api/tags/user.json"}],"author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}