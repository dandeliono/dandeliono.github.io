{"title":"tcpdump在启用TCP卸载功能的网卡上报告 checksum error ·","uid":"1bb022f0a90cc114ad2400e87144dac4","slug":"LINUX/tcpdump在启用TCP卸载功能的网卡上报告 checksum error ·","date":"2023-06-08T12:39:56.000Z","updated":"2025-09-30T03:26:39.106Z","comments":true,"path":"api/articles/LINUX/tcpdump在启用TCP卸载功能的网卡上报告 checksum error ·.json","keywords":"XuGuangSheng","cover":"/covers/tcpdumptcp-checksum-error.jpg","content":"<h1 id=\"tcpdump在启用TCP卸载功能的网卡上报告”checksum-error”-·\"><a href=\"#tcpdump在启用TCP卸载功能的网卡上报告”checksum-error”-·\" class=\"headerlink\" title=\"tcpdump在启用TCP卸载功能的网卡上报告”checksum error” ·\"></a>tcpdump在启用TCP卸载功能的网卡上报告”checksum error” ·</h1><p>在使用<code>tcpdump</code>对网卡进行抓包的时，很多时候会发现有<code>cksum incorrect</code>错误：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tcpdump -<span class=\"selector-tag\">i</span> eth0 -nn -vv -e</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>转包显示有很多<code>incorrect</code>数据包</p>\n<figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">11</span>:<span class=\"number\">54</span>:<span class=\"number\">08.747448</span> <span class=\"number\">00</span>:<span class=\"number\">16</span>:<span class=\"number\">3</span>e:<span class=\"number\">0</span>f:<span class=\"number\">02</span>:<span class=\"number\">76</span> &gt; <span class=\"number\">3</span>c:<span class=\"number\">8</span>c:<span class=\"number\">40</span>:<span class=\"number\">4</span>e:dd:<span class=\"number\">46</span>, ether<span class=\"keyword\">type</span> <span class=\"type\">IPv4</span> (0x0800), length 70: (tos 0x0, ttl 128, id 12416, offset 0, flags [<span class=\"type\">DF</span>], proto: <span class=\"type\">TCP</span> (6), length: 56) 69.172.201.153.20648 &gt; 218.92.186.154.32233: <span class=\"type\">P</span>, cksum 0xeace (incorrect (-&gt; 0xd8b6), 649:665(16) ack 0 win 511</span><br><span class=\"line\"><span class=\"number\">11</span>:<span class=\"number\">54</span>:<span class=\"number\">08.747631</span> <span class=\"number\">3</span>c:<span class=\"number\">8</span>c:<span class=\"number\">40</span>:<span class=\"number\">01</span>:<span class=\"number\">87</span>:f5 &gt; <span class=\"number\">00</span>:<span class=\"number\">16</span>:<span class=\"number\">3</span>e:<span class=\"number\">0</span>f:<span class=\"number\">02</span>:<span class=\"number\">76</span>, ether<span class=\"keyword\">type</span> <span class=\"type\">IPv4</span> (0x0800), length 60: (tos 0x0, ttl  54, id 43880, offset 0, flags [<span class=\"type\">DF</span>], proto: <span class=\"type\">TCP</span> (6), length: 40) 49.80.162.95.25453 &gt; 69.172.201.153.20648: ., cksum 0x08de (correct), 0:0(0) ack 643 win 64379</span><br><span class=\"line\"><span class=\"number\">11</span>:<span class=\"number\">54</span>:<span class=\"number\">08.747673</span> <span class=\"number\">3</span>c:<span class=\"number\">8</span>c:<span class=\"number\">40</span>:<span class=\"number\">02</span>:<span class=\"number\">72</span>:<span class=\"number\">68</span> &gt; <span class=\"number\">00</span>:<span class=\"number\">16</span>:<span class=\"number\">3</span>e:<span class=\"number\">0</span>f:<span class=\"number\">02</span>:<span class=\"number\">76</span>, ether<span class=\"keyword\">type</span> <span class=\"type\">IPv4</span> (0x0800), length 86: (tos 0x0, ttl  51, id 26279, offset 0, flags [<span class=\"type\">DF</span>], proto: <span class=\"type\">TCP</span> (6), length: 72) 49.81.57.179.18212 &gt; 69.172.201.153.5110: <span class=\"type\">P</span>, cksum 0xfc9e (correct), 1:33(32) ack 1 win 63939</span><br><span class=\"line\"><span class=\"number\">11</span>:<span class=\"number\">54</span>:<span class=\"number\">08.747685</span> <span class=\"number\">3</span>c:<span class=\"number\">8</span>c:<span class=\"number\">40</span>:<span class=\"number\">01</span>:<span class=\"number\">87</span>:f5 &gt; <span class=\"number\">00</span>:<span class=\"number\">16</span>:<span class=\"number\">3</span>e:<span class=\"number\">0</span>f:<span class=\"number\">02</span>:<span class=\"number\">76</span>, ether<span class=\"keyword\">type</span> <span class=\"type\">IPv4</span> (0x0800), length 60: (tos 0x0, ttl  51, id 16050, offset 0, flags [<span class=\"type\">DF</span>], proto: <span class=\"type\">TCP</span> (6), length: 40) 219.139.32.98.13599 &gt; 69.172.201.153.20648: ., cksum 0xc58e (correct), 4:4(0) ack 643 win 64523</span><br><span class=\"line\"><span class=\"number\">11</span>:<span class=\"number\">54</span>:<span class=\"number\">08.747777</span> <span class=\"number\">00</span>:<span class=\"number\">16</span>:<span class=\"number\">3</span>e:<span class=\"number\">0</span>f:<span class=\"number\">02</span>:<span class=\"number\">76</span> &gt; <span class=\"number\">3</span>c:<span class=\"number\">8</span>c:<span class=\"number\">40</span>:<span class=\"number\">4</span>e:dd:<span class=\"number\">46</span>, ether<span class=\"keyword\">type</span> <span class=\"type\">IPv4</span> (0x0800), length 62: (tos 0x0, ttl 128, id 6219, offset 0, flags [<span class=\"type\">DF</span>], proto: <span class=\"type\">TCP</span> (6), length: 48) 69.172.201.153.20648 &gt; 219.139.32.98.13599: <span class=\"type\">P</span>, cksum 0x51bd (incorrect (-&gt; 0x5783), 643:651(8) ack 4 win 511</span><br><span class=\"line\"><span class=\"number\">11</span>:<span class=\"number\">54</span>:<span class=\"number\">08.748145</span> <span class=\"number\">3</span>c:<span class=\"number\">8</span>c:<span class=\"number\">40</span>:<span class=\"number\">02</span>:<span class=\"number\">79</span>:e8 &gt; <span class=\"number\">00</span>:<span class=\"number\">16</span>:<span class=\"number\">3</span>e:<span class=\"number\">0</span>f:<span class=\"number\">02</span>:<span class=\"number\">76</span>, ether<span class=\"keyword\">type</span> <span class=\"type\">IPv4</span> (0x0800), length 60: (tos 0x0, ttl  54, id 16715, offset 0, flags [<span class=\"type\">DF</span>], proto: <span class=\"type\">TCP</span> (6), length: 40) 221.231.4.18.4134 &gt; 69.172.201.153.20648: ., cksum 0x78e2 (correct), 0:0(0) ack 643 win 65519</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>上述案例中IP地址是伪造的，仅做示例</p></blockquote>\n<p>参考 <a href=\"https://sokratisg.net/2012/04/01/udp-tcp-checksum-errors-from-tcpdump-nic-hardware-offloading/\">UDP &#x2F; TCP Checksum errors from tcpdump &amp; NIC Hardware Offloading</a></p>\n<p>当是使用<code>tcpdump</code>跟踪<code>UDP</code>或<code>TCP</code>数据流的时候，会看到大多数数据包显示<code>checksum</code>错误，这是因为网卡(NIC)启用了<code>checksum offloading</code>而<code>tcpdump</code>是从内核读取IP数据包，比NIC网卡芯片执行checksum要早。检查命令的方法是（假设检查DNS查询的数据包）</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">sudo</span> tcpdump -i eth0 -vvv -nn udp dst port <span class=\"number\">53</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>我模仿使用如下命令检查虚拟机<code>69.172.201.153.123</code>的UDP包，可以看到发出的UDP包的<code>checksum</code>都是错误的，从外面返回的UDP包则显示<code>checksum</code>正常</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">sudo</span> tcpdump -i eth0 -vvv -nn udp and host <span class=\"number\">69.172.201.153</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>可以看到</p>\n<figure class=\"highlight dns\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcpdump: WARNING: eth0: no IPv4 address assigned</span><br><span class=\"line\">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size <span class=\"number\">96</span> bytes</span><br><span class=\"line\"><span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">26.388718</span> IP (tos <span class=\"number\">0</span>xc0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">0</span>, offset <span class=\"number\">0</span>, flags [DF], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">76</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">123</span> &gt; <span class=\"number\">58.216.105.122</span>: [bad udp cksum <span class=\"number\">559</span>b!] NTPv4, length <span class=\"number\">48</span></span><br><span class=\"line\">    Client, Leap indicator:  (<span class=\"number\">0</span>), Stratum <span class=\"number\">3</span>, poll <span class=\"number\">7</span>s, precision -<span class=\"number\">22</span></span><br><span class=\"line\">    Root Delay: <span class=\"number\">0.030166</span>, Root dispersion: <span class=\"number\">0.024185</span>, Reference-ID: <span class=\"number\">110.75.186.249</span></span><br><span class=\"line\">      Reference Timestamp:  <span class=\"number\">3677372472</span>.<span class=\"number\">395108491</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">21</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">      Originator Timestamp: <span class=\"number\">3677372596</span>.<span class=\"number\">423037379</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">23</span>:<span class=\"number\">16</span>)</span><br><span class=\"line\">      Receive Timestamp:    <span class=\"number\">3677372596</span>.<span class=\"number\">434980779</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">23</span>:<span class=\"number\">16</span>)</span><br><span class=\"line\">      Transmit Timestamp:   <span class=\"number\">3677372726</span>.<span class=\"number\">389321297</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">26</span>)</span><br><span class=\"line\">        Originator - Receive Timestamp:  +<span class=\"number\">0</span>.<span class=\"number\">011943411</span></span><br><span class=\"line\">        Originator - Transmit Timestamp: +<span class=\"number\">129</span>.<span class=\"number\">966283917</span></span><br><span class=\"line\"><span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">26.412829</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">57</span>, id <span class=\"number\">0</span>, offset <span class=\"number\">0</span>, flags [DF], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">76</span>) <span class=\"number\">58.216.105.122</span> &gt; <span class=\"number\">69.172.201.153</span>.<span class=\"number\">123</span>: [udp sum ok] NTPv4, length <span class=\"number\">48</span></span><br><span class=\"line\">    Server, Leap indicator:  (<span class=\"number\">0</span>), Stratum <span class=\"number\">2</span>, poll <span class=\"number\">7</span>s, precision -<span class=\"number\">24</span></span><br><span class=\"line\">    Root Delay: <span class=\"number\">0.000106</span>, Root dispersion: <span class=\"number\">0.001434</span>, Reference-ID: <span class=\"number\">10.137.38.86</span></span><br><span class=\"line\">      Reference Timestamp:  <span class=\"number\">3677372712</span>.<span class=\"number\">335200518</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">      Originator Timestamp: <span class=\"number\">3677372726</span>.<span class=\"number\">389321297</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">26</span>)</span><br><span class=\"line\">      Receive Timestamp:    <span class=\"number\">3677372726</span>.<span class=\"number\">401639968</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">26</span>)</span><br><span class=\"line\">      Transmit Timestamp:   <span class=\"number\">3677372726</span>.<span class=\"number\">401653856</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">26</span>)</span><br><span class=\"line\">        Originator - Receive Timestamp:  +<span class=\"number\">0</span>.<span class=\"number\">012318663</span></span><br><span class=\"line\">        Originator - Transmit Timestamp: +<span class=\"number\">0</span>.<span class=\"number\">012332545</span></span><br><span class=\"line\"><span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">30.386709</span> IP (tos <span class=\"number\">0</span>xc0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">0</span>, offset <span class=\"number\">0</span>, flags [DF], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">76</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">123</span> &gt; <span class=\"number\">110.75.186.248</span>.<span class=\"number\">123</span>: [bad udp cksum <span class=\"number\">8059</span>!] NTPv4, length <span class=\"number\">48</span></span><br><span class=\"line\">    Client, Leap indicator:  (<span class=\"number\">0</span>), Stratum <span class=\"number\">3</span>, poll <span class=\"number\">10</span>s, precision -<span class=\"number\">22</span></span><br><span class=\"line\">    Root Delay: <span class=\"number\">0.030166</span>, Root dispersion: <span class=\"number\">0.024246</span>, Reference-ID: <span class=\"number\">110.75.186.249</span></span><br><span class=\"line\">      Reference Timestamp:  <span class=\"number\">3677372472</span>.<span class=\"number\">395108491</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">21</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">      Originator Timestamp: <span class=\"number\">0</span>.<span class=\"number\">000000000</span></span><br><span class=\"line\">      Receive Timestamp:    <span class=\"number\">0</span>.<span class=\"number\">000000000</span></span><br><span class=\"line\">      Transmit Timestamp:   <span class=\"number\">3677372730</span>.<span class=\"number\">387331545</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">30</span>)</span><br><span class=\"line\">        Originator - Receive Timestamp:  <span class=\"number\">0</span>.<span class=\"number\">000000000</span></span><br><span class=\"line\">        Originator - Transmit Timestamp: <span class=\"number\">3677372730</span>.<span class=\"number\">387331545</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">30</span>)</span><br><span class=\"line\"><span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">32.387721</span> IP (tos <span class=\"number\">0</span>xc0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">0</span>, offset <span class=\"number\">0</span>, flags [DF], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">76</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">123</span> &gt; <span class=\"number\">115.28.122.198</span>.<span class=\"number\">123</span>: [bad udp cksum <span class=\"number\">4</span>b0a!] NTPv4, length <span class=\"number\">48</span></span><br><span class=\"line\">    Client, Leap indicator:  (<span class=\"number\">0</span>), Stratum <span class=\"number\">3</span>, poll <span class=\"number\">7</span>s, precision -<span class=\"number\">22</span></span><br><span class=\"line\">    Root Delay: <span class=\"number\">0.030166</span>, Root dispersion: <span class=\"number\">0.024276</span>, Reference-ID: <span class=\"number\">110.75.186.249</span></span><br><span class=\"line\">      Reference Timestamp:  <span class=\"number\">3677372472</span>.<span class=\"number\">395108491</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">21</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">      Originator Timestamp: <span class=\"number\">3677372601</span>.<span class=\"number\">409083545</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">23</span>:<span class=\"number\">21</span>)</span><br><span class=\"line\">      Receive Timestamp:    <span class=\"number\">3677372601</span>.<span class=\"number\">422362774</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">23</span>:<span class=\"number\">21</span>)</span><br><span class=\"line\">      Transmit Timestamp:   <span class=\"number\">3677372732</span>.<span class=\"number\">388339668</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">32</span>)</span><br><span class=\"line\">        Originator - Receive Timestamp:  +<span class=\"number\">0.013279223</span></span><br><span class=\"line\">        Originator - Transmit Timestamp: +<span class=\"number\">130.979256153</span></span><br><span class=\"line\"><span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">32.419074</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">54</span>, id <span class=\"number\">0</span>, offset <span class=\"number\">0</span>, flags [DF], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">76</span>) <span class=\"number\">115.28.122.198</span>.<span class=\"number\">123</span> &gt; <span class=\"number\">69.172.201.153</span>.<span class=\"number\">123</span>: [udp sum ok] NTPv4, length <span class=\"number\">48</span></span><br><span class=\"line\">    Server, Leap indicator:  (<span class=\"number\">0</span>), Stratum <span class=\"number\">2</span>, poll <span class=\"number\">7</span>s, precision -<span class=\"number\">24</span></span><br><span class=\"line\">    Root Delay: <span class=\"number\">0.041046</span>, Root dispersion: <span class=\"number\">0.002349</span>, Reference-ID: <span class=\"number\">10.137.38.86</span></span><br><span class=\"line\">      Reference Timestamp:  <span class=\"number\">3677372656</span>.<span class=\"number\">633167505</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">24</span>:<span class=\"number\">16</span>)</span><br><span class=\"line\">      Originator Timestamp: <span class=\"number\">3677372732</span>.<span class=\"number\">388339668</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">32</span>)</span><br><span class=\"line\">      Receive Timestamp:    <span class=\"number\">3677372732</span>.<span class=\"number\">406500339</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">32</span>)</span><br><span class=\"line\">      Transmit Timestamp:   <span class=\"number\">3677372732</span>.<span class=\"number\">406535744</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">12</span>:<span class=\"number\">25</span>:<span class=\"number\">32</span>)</span><br><span class=\"line\">        Originator - Receive Timestamp:  +<span class=\"number\">0.018160656</span></span><br><span class=\"line\">        Originator - Transmit Timestamp: +<span class=\"number\">0.018196072</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>检查 <code>eth0</code>，发现原来<code>tx-checksumming</code>是开启的，而<code>rx-checksumming</code>则是关闭的</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">sudo</span> ethtool -k eth0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>输出</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Offload parameters for eth0</span><span class=\"punctuation\">:</span></span><br><span class=\"line\"><span class=\"attribute\">rx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">tx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">scatter-gather</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">tcp segmentation offload</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">udp fragmentation offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">generic segmentation offload</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">generic-receive-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>这台物理服务器上运行了虚拟化，在虚拟机中测试了<code>dig @8.8.8.8 www.sina.com.cn</code>，可以在物理服务器上抓包显示</p>\n<figure class=\"highlight dns\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">09</span>:<span class=\"number\">49.944926</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">48092</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">61</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">37421</span> &gt; <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span>: [bad udp cksum b1aa!]  <span class=\"number\">12774</span>+ <span class=\"keyword\">A</span>? www.sina.com.cn. (<span class=\"number\">33</span>)</span><br><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">09</span>:<span class=\"number\">50.945615</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">48093</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">61</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">37421</span> &gt; <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span>: [bad udp cksum b1aa!]  <span class=\"number\">12774</span>+ <span class=\"keyword\">A</span>? www.sina.com.cn. (<span class=\"number\">33</span>)</span><br><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">09</span>:<span class=\"number\">51.018821</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">42</span>, id <span class=\"number\">23786</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">183</span>) <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span> &gt; <span class=\"number\">69.172.201.153</span>.<span class=\"number\">37421</span>:  <span class=\"number\">12774</span> q: <span class=\"keyword\">A</span>? www.sina.com.cn. <span class=\"number\">5</span>/<span class=\"number\">0</span>/<span class=\"number\">0</span> www.sina.com.cn. <span class=\"keyword\">CNAME</span>[|domain]</span><br><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">09:51.092146</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">42</span>, id <span class=\"number\">51428</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">183</span>) <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span> &gt; <span class=\"number\">69.172.201.153</span>.<span class=\"number\">37421</span>:  <span class=\"number\">12774</span> q: <span class=\"keyword\">A</span>? www.sina.com.cn. <span class=\"number\">5</span>/<span class=\"number\">0</span>/<span class=\"number\">0</span> www.sina.com.cn. <span class=\"keyword\">CNAME</span>[|domain]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>尝试在虚拟机中关闭<code>TCO</code>(注意，<code>ethtool</code>检查的时候参数是小写的<code>-k</code>，当<code>ethtool</code>设置参数的时候是大写的<code>-K</code>)</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">ethtool</span> -K eth1 tx <span class=\"literal\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Actual changes</span><span class=\"punctuation\">:</span></span><br><span class=\"line\"><span class=\"attribute\">rx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">tx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">scatter-gather</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">tcp-segmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">udp-fragmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>再次检查，发现<code>rx</code>和<code>tx</code>的<code>checksum</code>被同时关闭了</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">ethtool -k eth1</span></span><br><span class=\"line\"><span class=\"attribute\">Features for eth1</span><span class=\"punctuation\">:</span></span><br><span class=\"line\"><span class=\"attribute\">rx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">tx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">scatter-gather</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">tcp-segmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">udp-fragmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">generic-segmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">generic-receive-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">large-receive-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">ntuple-filters</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">receive-hashing</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>奇怪：怎么<code>tx off</code>设置会同时关闭<code>tx</code>和<code>rx</code>的checksum?</p></blockquote>\n<p>不过，验证下来发现，在虚拟机中关闭<code>TCO</code>（<code>tx-checksumming</code>和<code>rx-checksumming</code>）后，在NC上抓包显示，已经不再出现数据包发送的时候的<code>checksum</code>错误</p>\n<figure class=\"highlight dns\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">14</span>:<span class=\"number\">54.749620</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">48095</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">61</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">53614</span> &gt; <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span>: [udp sum ok]  <span class=\"number\">4027</span>+ <span class=\"keyword\">A</span>? www.sina.com.cn. (<span class=\"number\">33</span>)</span><br><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">14</span>:<span class=\"number\">54.964426</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">42</span>, id <span class=\"number\">19522</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">183</span>) <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span> &gt; <span class=\"number\">69.172.201.153</span>.<span class=\"number\">53614</span>:  <span class=\"number\">4027</span> q: <span class=\"keyword\">A</span>? www.sina.com.cn. <span class=\"number\">5</span>/<span class=\"number\">0</span>/<span class=\"number\">0</span> www.sina.com.cn. <span class=\"keyword\">CNAME</span>[|domain]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">16:12.388133</span> IP (tos <span class=\"number\">0</span>xc0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">0</span>, offset <span class=\"number\">0</span>, flags [DF], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">76</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">123</span> &gt; <span class=\"number\">58.216.105.122</span>: [udp sum ok] NTPv4, length <span class=\"number\">48</span></span><br><span class=\"line\">    Client, Leap indicator:  (<span class=\"number\">0</span>), Stratum <span class=\"number\">3</span>, poll <span class=\"number\">9</span>s, precision -<span class=\"number\">22</span></span><br><span class=\"line\">    Root Delay: <span class=\"number\">0.030258</span>, Root dispersion: <span class=\"number\">0.028045</span>, Reference-ID: <span class=\"number\">10.143.33.50</span></span><br><span class=\"line\">      Reference Timestamp:  <span class=\"number\">3677375656</span>.<span class=\"number\">402239203</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">14</span>:<span class=\"number\">16</span>)</span><br><span class=\"line\">      Originator Timestamp: <span class=\"number\">3677375243</span>.<span class=\"number\">399526447</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">07</span>:<span class=\"number\">23</span>)</span><br><span class=\"line\">      Receive Timestamp:    <span class=\"number\">3677375243</span>.<span class=\"number\">411563843</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">07</span>:<span class=\"number\">23</span>)</span><br><span class=\"line\">      Transmit Timestamp:   <span class=\"number\">3677375772</span>.<span class=\"number\">388326644</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">16</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">        Originator - Receive Timestamp:  +<span class=\"number\">0</span>.<span class=\"number\">012037376</span></span><br><span class=\"line\">        Originator - Transmit Timestamp: +<span class=\"number\">528</span>.<span class=\"number\">988800168</span></span><br><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">16:12.412254</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">57</span>, id <span class=\"number\">0</span>, offset <span class=\"number\">0</span>, flags [DF], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">76</span>) <span class=\"number\">58.216.105.122</span> &gt; <span class=\"number\">69.172.201.153</span>.<span class=\"number\">123</span>: [udp sum ok] NTPv4, length <span class=\"number\">48</span></span><br><span class=\"line\">    Server, Leap indicator:  (<span class=\"number\">0</span>), Stratum <span class=\"number\">2</span>, poll <span class=\"number\">9</span>s, precision -<span class=\"number\">24</span></span><br><span class=\"line\">    Root Delay: <span class=\"number\">0.000106</span>, Root dispersion: <span class=\"number\">0.002014</span>, Reference-ID: <span class=\"number\">10.137.38.86</span></span><br><span class=\"line\">      Reference Timestamp:  <span class=\"number\">3677375704</span>.<span class=\"number\">335250139</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">15</span>:<span class=\"number\">04</span>)</span><br><span class=\"line\">      Originator Timestamp: <span class=\"number\">3677375772</span>.<span class=\"number\">388326644</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">16</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">      Receive Timestamp:    <span class=\"number\">3677375772</span>.<span class=\"number\">400358736</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">16</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">      Transmit Timestamp:   <span class=\"number\">3677375772</span>.<span class=\"number\">400375515</span> (<span class=\"number\">2016/07/13</span> <span class=\"number\">13</span>:<span class=\"number\">16</span>:<span class=\"number\">12</span>)</span><br><span class=\"line\">        Originator - Receive Timestamp:  +<span class=\"number\">0</span>.<span class=\"number\">012032079</span></span><br><span class=\"line\">        Originator - Transmit Timestamp: +<span class=\"number\">0</span>.<span class=\"number\">012048868</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>再次恢复虚拟机的<code>TCO</code></p>\n<figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@houyiecsayZ14464544641Z ~]<span class=\"comment\"># ethtool -K eth1 tx on</span></span><br><span class=\"line\">Actual changes:</span><br><span class=\"line\">rx-checksumming: <span class=\"literal\">on</span></span><br><span class=\"line\">tx-checksumming: <span class=\"literal\">on</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>可以看到抓包显示依然出现了UDP发送包的chksum错误</p>\n<figure class=\"highlight dns\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">18</span>:<span class=\"number\">47.851459</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">64</span>, id <span class=\"number\">48096</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">61</span>) <span class=\"number\">69.172.201.153</span>.<span class=\"number\">51360</span> &gt; <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span>: [bad udp cksum <span class=\"number\">256</span>e!]  <span class=\"number\">14335</span>+ <span class=\"keyword\">A</span>? www.sina.com.cn. (<span class=\"number\">33</span>)</span><br><span class=\"line\"><span class=\"number\">13</span>:<span class=\"number\">18</span>:<span class=\"number\">47.983450</span> IP (tos <span class=\"number\">0</span>x0, ttl  <span class=\"number\">42</span>, id <span class=\"number\">47800</span>, offset <span class=\"number\">0</span>, flags [none], proto: UDP (<span class=\"number\">17</span>), length: <span class=\"number\">183</span>) <span class=\"number\">8.8.8.8</span>.<span class=\"number\">53</span> &gt; <span class=\"number\">69.172.201.153</span>.<span class=\"number\">51360</span>:  <span class=\"number\">14335</span> q: <span class=\"keyword\">A</span>? www.sina.com.cn. <span class=\"number\">5</span>/<span class=\"number\">0</span>/<span class=\"number\">0</span> www.sina.com.cn. <span class=\"keyword\">CNAME</span>[|domain]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>注意：为了避免性能问题，完成测试后需要恢复开启<code>TCO</code>功能</strong></p>\n<h2 id=\"原理简述\"><a href=\"#原理简述\" class=\"headerlink\" title=\"原理简述\"></a>原理简述</h2><p><a href=\"https://huataihuang.gitbooks.io/cloud-atlas/content/network/packet_analysis/tcpdump/Too%20many%20incorrect%20checksum%20errors%20in%20TCPDUMP\">Too many incorrect checksum errors in TCPDUMP</a>提供了明确的解释：</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>这个<code>incorrect</code> checksum是一个称为TCP checksum offloading的功能，这个发出的TCP数据包的checksum字段在通过操作系统时是没有预先计算但被设置成<code>0</code>，然后留给通过NIC网卡处理器的时候进行校验计算。</p></blockquote>\n<p>在<a href=\"http://www.wireshark.org/faq.html#q10.1\">Wireshark FAQ</a>提供了对数据包分析工具角度说明：</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>如果发送给运行Wireshrk服务器的数据包显示有TCP checksum错误，可能是因为使用的网卡配置了TCP checksum offloading功能。这意味着TCP checksum功能通过网卡添加到了数据包中，而不是通过操作系统的TCP&#x2F;IP堆栈来添加。当在网卡接口上进行数据包捕捉时，通过主机发送的数据包是直接由操作系统在数据包捕捉接口上处理的，意味着此时数据包还没有添加一个TCP checksum。</p>\n<p>解决的唯一方法是禁止TCP checksum offloading，但是在一些操作系统不允许这么操作，并且会导致明显的网络性能下降。然而，可以关闭Wireshark的TCP checksum error报告功能，这样它就不会在数据包有错误TCP checksum时拒绝执行TCP重组。设置方法是在WireShark的<code>Perferences</code>中，在<code>Protocols</code>列表中选择<code>TCP</code> ，然后关闭<code>Check the validity of the TCP checksum when possible</code>。也可以在命令行使用参数<code>-o tcp.check_checksum:false</code></p></blockquote>\n<h2 id=\"原理详解\"><a href=\"#原理详解\" class=\"headerlink\" title=\"原理详解\"></a>原理详解</h2><p>大多数现代操作系统都支持网络卸载（network offloading）功能，即部分网络处理由网卡完成而不是由CPU处理。这样可以释放系统资源以便能够处理更多的连接。不过对于数据包捕捉分析会带来一些较为奇怪的结果或者丢失一些流量。</p>\n<p><strong><code>Checksum Offloading</code></strong></p>\n<p>在支持checksum offloading的系统中，IP,TCP和UDP checksum可以在传输到网线之前由网卡NIC来完成。此时在Wirshark中会提示数据包错误<code>[incorrect, should be xxxx (maybe caused by &quot;TCP checksum offload&quot;?)].</code>（tcpdump也有同样提示<code>cksum xxxx incorrect</code>）。抓包工具Wireshark&#x2F;Tcpdump是在数据包被发送给网卡之前捕捉数据包的，此时它不会看到正确的checksum，因为此时尚未进行计算（因为checksum已经卸载到网卡，此时这个checksum字段会被填写为0）。这也就导致了抓包工具提示checksum错误的原因。</p>\n<p>要通过抓包工具来观察数据包是否真的存在checksum错误，可以暂时关闭网卡的<code>checksum offload</code>功能，验证完成后再恢复网卡的<code>checksum offload</code>（关闭TCO会有性能问题）</p>\n<p><strong><code>Segmentation Offloading</code></strong></p>\n<p>以下图示显示了TCP&#x2F;IP堆栈没有卸载的时候数据包，假设应用数据包(Application data)是7300字节，此时TCP将把应用数据包切分成5个分片（segments），这是因为以太网的最大传输单元（Maximum Transmission Unit, MTU）是<code>1500字节</code>，此外我们还要减去<code>20字节的IP头部</code>以及<code>20字节的TCP头部</code>，实际能够用于数据传输的TCP分片只有<code>1460字节</code>(也就是TCP最大分片大小，TCP Maximum Segment Size, MSS)。</p>\n<p><img src=\"https://huataihuang.gitbooks.io/cloud-atlas/content/img/network/packet_analysis/wireshark-capture-1.png\"></p>\n<p>当使用了网卡提供的<code>segmentation offloading</code>功能，操作系统就不会对应用数据（application data）进行分片，而是直接将一个大的TCP&#x2F;IP包发送给驱动程序。此时TCP和IP头部实际上是一个临时头部。驱动程序会创建一个单一的巨大的以太网帧，此时这个巨大的以太网帧会被包捕捉工具（如Wireshark）捕捉到，然后再发送给物理网卡。最后，网卡才执行提以太网帧分片，此时网卡会把使用这个临时头部来创建真实的TCP&#x2F;IP以太网头部并生成5个以太网帧，最后这5个以太网帧才发送到网络中。</p>\n<p><img src=\"https://huataihuang.gitbooks.io/cloud-atlas/content/img/network/packet_analysis/wireshark-capture-2.png\"></p>\n<p>上述过程，如果启用了<code>segmentation offloading</code>，则抓包工具wireshark只能捕捉到一个巨大的以太网帧（包含7300字节数据）</p>\n<ul>\n<li>Linux操作系统</li>\n</ul>\n<p>检查<code>checksum offload</code></p>\n<figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ethtool <span class=\"comment\">--show-offload ethX</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>关闭<code>checksum offload</code></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">ethtool</span> --offload ethX rx <span class=\"literal\">off</span> tx <span class=\"literal\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>或者使用命令</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">ethtool</span> -K ethX rx <span class=\"literal\">off</span> tx <span class=\"literal\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>在<a href=\"http://blog.securityonion.net/2011/10/when-is-full-packet-capture-not-full.html\">When is full packet capture NOT full packet capture?</a>中整理提供了非常好的说明</p>\n<table>\n<thead>\n<tr>\n<th>NIC offload功能列表</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>tso</code></td>\n<td><a href=\"http://en.wikipedia.org/wiki/Large_segment_offload\">tcp-segmentation-offload</a> TCP分片卸载</td>\n</tr>\n<tr>\n<td><code>gso</code></td>\n<td><a href=\"http://lwn.net/Articles/188489/\">genteric-segmentation-offload</a> 通用分片卸载</td>\n</tr>\n<tr>\n<td><code>gro</code></td>\n<td><a href=\"http://lwn.net/Articles/358910/\">generic-receive-offload</a> 通用接收卸载</td>\n</tr>\n</tbody></table>\n<p>例如使用<code>ethtool -k eth0</code>可能可以看到如下输出</p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Offload parameters for eth0</span><span class=\"punctuation\">:</span></span><br><span class=\"line\"><span class=\"attribute\">rx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">tx-checksumming</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">scatter-gather</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">tcp-segmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">udp-fragmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"><span class=\"attribute\">generic-segmentation-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">generic-receive-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">on</span></span><br><span class=\"line\"><span class=\"attribute\">large-receive-offload</span><span class=\"punctuation\">:</span> <span class=\"string\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>关闭<code>offload</code>设置的方法案例</p>\n<figure class=\"highlight mathematica\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">rx</span> <span class=\"variable\">off</span></span><br><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">tx</span> <span class=\"variable\">off</span></span><br><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">sg</span> <span class=\"variable\">off</span></span><br><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">tso</span> <span class=\"variable\">off</span></span><br><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">ufo</span> <span class=\"variable\">off</span></span><br><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">gso</span> <span class=\"variable\">off</span></span><br><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">gro</span> <span class=\"variable\">off</span></span><br><span class=\"line\"><span class=\"variable\">ethtool</span> <span class=\"operator\">-</span><span class=\"built_in\">K</span> <span class=\"variable\">eth0</span> <span class=\"variable\">lro</span> <span class=\"variable\">off</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意，上述设置是<code>flying</code>的，不是持久化设置。要持久化设置，需要修改网卡配置，例如RedHat操作系统的<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code>配置</p>\n<p>Broadcom 早期的<code>tg3</code>的驱动可能在启用<code>tso</code>的时候会导致数据包不正确 - <a href=\"http://www.running-system.com/take-care-if-using-an-older-broadcom-tg3-driver-tso-enabled-at-your-esxi-host/\">Take care if using an older Broadcom tg3 driver + TSO enabled at your ESXi host</a>，在生产环境中也遇到过<code>tg3</code>启用<code>tso</code>之后导致内存分配错误</p></blockquote>\n<ul>\n<li>Windows操作系统</li>\n</ul>\n<p>在虚拟化环境中，Windows虚拟机启用TCP Offloading可能会存在一些问题，可以通过下面的方法来禁用Windows虚拟机TCP Offloading（物理服务器设置方法相同）</p>\n<p>在Windows操作系统的控制面板（<code>Control Pannel</code>）中选择**<code>Network Settings &gt; Change Adapter Settings</code><strong>，然后鼠标右击每个网卡，选择</strong><code>Networking</code><strong>菜单的</strong><code>Configure</code><strong>，然后点击</strong><code>Advanced</code>**面板，此时可以看到<code>TCP offload</code>相关设置（下图是Citrix adapter虚拟网卡）</p>\n<p><img src=\"https://huataihuang.gitbooks.io/cloud-atlas/content/img/network/packet_analysis/tcp_offloading_in_windows.png\"></p>\n<p>关闭TCP offload相关的以下选项，然后点击**<code>ok</code>**</p>\n<figure class=\"highlight excel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IPv4 Checksum Offload</span><br><span class=\"line\"><span class=\"built_in\">Large</span> Receive Offload</span><br><span class=\"line\"><span class=\"built_in\">Large</span> Send Offload</span><br><span class=\"line\">TCP Checksum Offload</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Windows操作系统<code>Chimney Offload</code>操作方法</li>\n</ul>\n<p>在Windows操作系统中检查tcp设置</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh <span class=\"type\">int</span> tcp <span class=\"keyword\">show</span> <span class=\"keyword\">global</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>关闭<code>chimney offload</code></p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh int tcp <span class=\"built_in\">set</span> global <span class=\"attribute\">chimney</span>=disabled</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>开启<code>chimney offload</code></p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh int tcp <span class=\"built_in\">set</span> global <span class=\"attribute\">chimney</span>=enabled</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong><code>Chimney offloading</code>是一种通过网卡NIC卸载处理TCP连接的技术</strong>，在启用了<code>chimney offloading</code>的Windows操作系统，可以通过命令</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">netstat -t</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>观察到如下输出</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Active</span> Connections</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attribute\">Proto</span>  Local Address          Foreign Address        State           Offload State</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attribute\">TCP</span>    <span class=\"number\">127.0.0.1:52613</span>        computer_name:<span class=\"number\">52614</span>       ESTABLISHED     InHost</span><br><span class=\"line\">  <span class=\"attribute\">TCP</span>    <span class=\"number\">192.168.1.103:52614</span>        computer_name:<span class=\"number\">52613</span>       ESTABLISHED     Offloaded</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>其中，第二行标记了<code>Offloaded</code>就是表示这个连接已经被网卡的Chimney offloading卸载了，这样系统可以承受更多的TCP连接。</p>\n<ul>\n<li><a href=\"https://sokratisg.net/2012/04/01/udp-tcp-checksum-errors-from-tcpdump-nic-hardware-offloading/\">UDP &#x2F; TCP Checksum errors from tcpdump &amp; NIC Hardware Offloading</a></li>\n<li><a href=\"http://sandilands.info/sgordon/segmentation-offloading-with-wireshark-and-ethtool\">Segmentation and Checksum Offloading: Turning Off with ethtool</a></li>\n<li><a href=\"https://wiki.wireshark.org/CaptureSetup/Offloading\">WireShark: CaptureSetup&#x2F;Offloading</a></li>\n<li><a href=\"http://blog.securityonion.net/2011/10/when-is-full-packet-capture-not-full.html\">When is full packet capture NOT full packet capture?</a></li>\n<li><a href=\"https://support.rackspace.com/how-to/disabling-tcp-offloading-in-windows-server-2012/\">Disable TCP Offloading in Windows Server 2012</a></li>\n<li><a href=\"https://support.microsoft.com/en-us/kb/951037\">Information about the TCP Chimney Offload, Receive Side Scaling, and Network Direct Memory Access features in Windows Server 2008</a> 微软官方文档，提供了TCP Chimney Offload（也就是TCP连接的卸载功能）以及接收滑动窗口，网络直接内存访问的相关设置，对于Windows Server 2008操作系统的参考非常详尽</li>\n</ul>\n","text":"tcpdump在启用TCP卸载功能的网卡上报告”checksum error” ·在使用tcpdump对网卡进行抓包的时，很多时候会发现有cksum incor...","permalink":"/post/LINUX/tcpdump在启用TCP卸载功能的网卡上报告 checksum error ·","photos":[],"count_time":{"symbolsCount":"15k","symbolsTime":"14 mins."},"categories":[{"name":"TCP","slug":"TCP","count":3,"path":"api/categories/TCP.json"},{"name":"LINUX","slug":"TCP/LINUX","count":1,"path":"api/categories/TCP/LINUX.json"}],"tags":[{"name":"checksum","slug":"checksum","count":1,"path":"api/tags/checksum.json"},{"name":"offloading","slug":"offloading","count":1,"path":"api/tags/offloading.json"},{"name":"offload","slug":"offload","count":1,"path":"api/tags/offload.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#tcpdump%E5%9C%A8%E5%90%AF%E7%94%A8TCP%E5%8D%B8%E8%BD%BD%E5%8A%9F%E8%83%BD%E7%9A%84%E7%BD%91%E5%8D%A1%E4%B8%8A%E6%8A%A5%E5%91%8A%E2%80%9Dchecksum-error%E2%80%9D-%C2%B7\"><span class=\"toc-text\">tcpdump在启用TCP卸载功能的网卡上报告”checksum error” ·</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0\"><span class=\"toc-text\">原理简述</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3\"><span class=\"toc-text\">原理详解</span></a></li></ol></li></ol>","author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Esper学习之一：Esper介绍","uid":"7959b0a0c2b89085e6f8a032821dbd4d","slug":"BIGDATA/Esper学习之一：Esper介绍","date":"2023-06-08T17:48:32.000Z","updated":"2025-09-30T03:26:03.131Z","comments":true,"path":"api/articles/BIGDATA/Esper学习之一：Esper介绍.json","keywords":"XuGuangSheng","cover":"/covers/esperesper.jpg","text":"Esper学习之一：Esper介绍CEP即Complex Event Process，中文意思就是“复杂事件处理”。听起来好像很复杂，实际上就是基于事件流进行数...","permalink":"/post/BIGDATA/Esper学习之一：Esper介绍","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"apple","slug":"apple","count":1,"path":"api/categories/apple.json"},{"name":"BIGDATA","slug":"apple/BIGDATA","count":1,"path":"api/categories/apple/BIGDATA.json"}],"tags":[{"name":"Esper","slug":"Esper","count":2,"path":"api/tags/Esper.json"},{"name":"esper","slug":"esper","count":2,"path":"api/tags/esper.json"},{"name":"Apple","slug":"Apple","count":2,"path":"api/tags/Apple.json"}],"author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"MySql Lock wait timeout exceeded","uid":"56ab2e24b6f8563e1b3aef14738d978d","slug":"MIDDLEWARE/MySql Lock wait timeout exceeded","date":"2023-05-17T15:04:27.000Z","updated":"2025-09-30T03:26:49.179Z","comments":true,"path":"api/articles/MIDDLEWARE/MySql Lock wait timeout exceeded.json","keywords":"XuGuangSheng","cover":"/covers/mysql-lock-wait-timeout-exceeded.jpg","text":"MySql Lock wait timeout exceededMysql造成锁的情况有很多，下面我们就列举一些情况： 执行DML操作没有commit，再执行删...","permalink":"/post/MIDDLEWARE/MySql Lock wait timeout exceeded","photos":[],"count_time":{"symbolsCount":"4k","symbolsTime":"4 mins."},"categories":[{"name":"innodb","slug":"innodb","count":1,"path":"api/categories/innodb.json"},{"name":"MIDDLEWARE","slug":"innodb/MIDDLEWARE","count":1,"path":"api/categories/innodb/MIDDLEWARE.json"}],"tags":[{"name":"wait","slug":"wait","count":1,"path":"api/tags/wait.json"},{"name":"timeout","slug":"timeout","count":1,"path":"api/tags/timeout.json"},{"name":"lock","slug":"lock","count":1,"path":"api/tags/lock.json"}],"author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}