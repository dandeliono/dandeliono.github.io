{"title":"OpenJDK 21 升级指南","uid":"7f131539c90d8df41f64ec3b38ed6275","slug":"OpenJDK 21 升级指南","date":"2025-12-02T15:42:40.000Z","updated":"2025-12-05T01:48:07.482Z","comments":true,"path":"api/articles/OpenJDK 21 升级指南.json","keywords":"XuGuangSheng","cover":"/covers/openjdk-21.jpg","content":"<h1 id=\"OpenJDK-21-升级指南\"><a href=\"#OpenJDK-21-升级指南\" class=\"headerlink\" title=\"OpenJDK 21 升级指南\"></a>OpenJDK 21 升级指南</h1><p><code>CommonAnnotationBeanPostProcessor.java</code></p>\n<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title class_\"><span class=\"keyword\">class</span> <span class=\"title\">CommonAnnotationBeanPostProcessor</span> <span class=\"keyword\"><span class=\"keyword\">extends</span> <span class=\"type\">InitDestroyAnnotationBeanPostProcessor</span></span></span></span><br><span class=\"line\"><span class=\"title class_\">    <span class=\"keyword\"><span class=\"keyword\">implements</span> <span class=\"type\">InstantiationAwareBeanPostProcessor</span></span>, <span class=\"title\">BeanFactoryAware</span>, <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Defensive reference to JNDI API for JDK 9+ (optional java.naming module)</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> boolean jndiPresent = ClassUtils.isPresent(</span><br><span class=\"line\">      <span class=\"string\">&quot;javax.naming.InitialContext&quot;</span>, CommonAnnotationBeanPostProcessor.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Set&lt;Class&lt;? extends Annotation&gt;&gt; resourceAnnotationTypes = CollectionUtils.<span class=\"keyword\">new</span><span class=\"type\">LinkedHashSet</span>(<span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Class&lt;? extends Annotation&gt; jakartaResourceType;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Class&lt;? extends Annotation&gt; javaxResourceType;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Class&lt;? extends Annotation&gt; ejbAnnotationType;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    jakartaResourceType = loadAnnotationType(<span class=\"string\">&quot;jakarta.annotation.Resource&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (jakartaResourceType != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      resourceAnnotationTypes.add(jakartaResourceType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    javaxResourceType = loadAnnotationType(<span class=\"string\">&quot;javax.annotation.Resource&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (javaxResourceType != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      resourceAnnotationTypes.add(javaxResourceType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ejbAnnotationType = loadAnnotationType(<span class=\"string\">&quot;jakarta.ejb.EJB&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ejbAnnotationType != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      resourceAnnotationTypes.add(ejbAnnotationType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Set&lt;<span class=\"keyword\">String</span>&gt; ignoredResourceTypes = <span class=\"keyword\">new</span> <span class=\"type\">HashSet</span>&lt;&gt;(<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> InjectionMetadata buildResourceMetadata(Class&lt;?&gt; clazz) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!AnnotationUtils.isCandidateClass(clazz, resourceAnnotationTypes)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> InjectionMetadata.EMPTY;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    List&lt;InjectionMetadata.InjectedElement&gt; elements = <span class=\"keyword\">new</span> <span class=\"type\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">    Class&lt;?&gt; targetClass = clazz;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">final</span> List&lt;InjectionMetadata.InjectedElement&gt; currElements = <span class=\"keyword\">new</span> <span class=\"type\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">      ReflectionUtils.doWithLocalFields(targetClass, field -&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ejbAnnotationType != <span class=\"literal\">null</span> &amp;&amp; field.isAnnotationPresent(ejbAnnotationType)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@EJB annotation is not supported on static fields&quot;</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          currElements.add(<span class=\"keyword\">new</span> <span class=\"type\">EjbRefElement</span>(field, field, <span class=\"literal\">null</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (jakartaResourceType != <span class=\"literal\">null</span> &amp;&amp; field.isAnnotationPresent(jakartaResourceType)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@Resource annotation is not supported on static fields&quot;</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (!<span class=\"built_in\">this</span>.ignoredResourceTypes.contains(field.getType().getName())) &#123;</span><br><span class=\"line\">            currElements.add(<span class=\"keyword\">new</span> <span class=\"type\">ResourceElement</span>(field, field, <span class=\"literal\">null</span>));</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (javaxResourceType != <span class=\"literal\">null</span> &amp;&amp; field.isAnnotationPresent(javaxResourceType)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@Resource annotation is not supported on static fields&quot;</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (!<span class=\"built_in\">this</span>.ignoredResourceTypes.contains(field.getType().getName())) &#123;</span><br><span class=\"line\">            currElements.add(<span class=\"keyword\">new</span> <span class=\"type\">LegacyResourceElement</span>(field, field, <span class=\"literal\">null</span>));</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">      ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;</span><br><span class=\"line\">        Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ejbAnnotationType != <span class=\"literal\">null</span> &amp;&amp; bridgedMethod.isAnnotationPresent(ejbAnnotationType)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@EJB annotation is not supported on static methods&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (method.getParameterCount() != <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@EJB annotation requires a single-arg method: &quot;</span> + method);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class=\"line\">            currElements.add(<span class=\"keyword\">new</span> <span class=\"type\">EjbRefElement</span>(method, bridgedMethod, pd));</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (jakartaResourceType != <span class=\"literal\">null</span> &amp;&amp; bridgedMethod.isAnnotationPresent(jakartaResourceType)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@Resource annotation is not supported on static methods&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (paramTypes.length != <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@Resource annotation requires a single-arg method: &quot;</span> + method);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"built_in\">this</span>.ignoredResourceTypes.contains(paramTypes[<span class=\"number\">0</span>].getName())) &#123;</span><br><span class=\"line\">              PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class=\"line\">              currElements.add(<span class=\"keyword\">new</span> <span class=\"type\">ResourceElement</span>(method, bridgedMethod, pd));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (javaxResourceType != <span class=\"literal\">null</span> &amp;&amp; bridgedMethod.isAnnotationPresent(javaxResourceType)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@Resource annotation is not supported on static methods&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (paramTypes.length != <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;@Resource annotation requires a single-arg method: &quot;</span> + method);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"built_in\">this</span>.ignoredResourceTypes.contains(paramTypes[<span class=\"number\">0</span>].getName())) &#123;</span><br><span class=\"line\">              PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class=\"line\">              currElements.add(<span class=\"keyword\">new</span> <span class=\"type\">LegacyResourceElement</span>(method, bridgedMethod, pd));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">      elements.addAll(<span class=\"number\">0</span>, currElements);</span><br><span class=\"line\">      targetClass = targetClass.getSuperclass();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (targetClass != <span class=\"literal\">null</span> &amp;&amp; targetClass != Object.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> InjectionMetadata.forElements(elements, clazz);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","feature":true,"text":"OpenJDK 21 升级指南CommonAnnotationBeanPostProcessor.java 12345678910111213141516171...","permalink":"/post/OpenJDK 21 升级指南","photos":[],"count_time":{"symbolsCount":"6.9k","symbolsTime":"6 mins."},"categories":[{"name":"OpenJDK","slug":"OpenJDK","count":1,"path":"api/categories/OpenJDK.json"}],"tags":[{"name":"升级指南","slug":"升级指南","count":1,"path":"api/tags/升级指南.json"},{"name":"CommonAnnotationBeanPostProcessor","slug":"CommonAnnotationBeanPostProcessor","count":1,"path":"api/tags/CommonAnnotationBeanPostProcessor.json"},{"name":"java","slug":"java","count":3,"path":"api/tags/java.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#OpenJDK-21-%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97\"><span class=\"toc-text\">OpenJDK 21 升级指南</span></a></li></ol>","author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{},"next_post":{"title":"使用 OpenRewrite 优化代码","uid":"f3ed7a9f2ae39ecacdf39c97b08052bb","slug":"使用 OpenRewrite 优化代码","date":"2025-12-02T14:30:55.000Z","updated":"2025-12-05T01:48:10.129Z","comments":true,"path":"api/articles/使用 OpenRewrite 优化代码.json","keywords":"XuGuangSheng","cover":"/covers/openrewrite.jpg","text":"使用 OpenRewrite 优化代码在 OpenJDK 21 升级指南 中提到， OpenRewrite 可以帮忙解决一些升级 OpenJDK 中发现的问题。...","permalink":"/post/使用 OpenRewrite 优化代码","photos":[],"count_time":{"symbolsCount":"5.3k","symbolsTime":"5 mins."},"categories":[{"name":"OpenRewrite","slug":"OpenRewrite","count":1,"path":"api/categories/OpenRewrite.json"}],"tags":[{"name":"Spring","slug":"Spring","count":1,"path":"api/tags/Spring.json"},{"name":"Java","slug":"Java","count":2,"path":"api/tags/Java.json"},{"name":"JUnit","slug":"JUnit","count":1,"path":"api/tags/JUnit.json"}],"author":{"name":"dandeliono","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/29496357","link":"/","description":"永远相信美好的事情即将发生","socials":{"github":"https://github.com/dandeliono","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}